<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>SEIMS-2016: preprocess/cpp_src/TauDEM/streamnet.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">SEIMS-2016
   &#160;<span id="projectnumber">1.0-beta</span>
   </div>
   <div id="projectbrief">Spatially Explicit Integrated Modeling System</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('de/de9/a00322_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">streamnet.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*  StreamNet function to compute stream networks based on d8 directions.</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">     </span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">  David Tarboton, Dan Watson, Jeremy Neff</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">  Utah State University  </span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">  May 23, 2010 </span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">/*  Copyright (C) 2010  David Tarboton, Utah State University</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">This program is free software; you can redistribute it and/or</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">modify it under the terms of the GNU General Public License </span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">version 2, 1991 as published by the Free Software Foundation.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">GNU General Public License for more details.</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">A copy of the full GNU General Public License is included in file </span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">gpl.html. This is also available at:</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">http://www.gnu.org/copyleft/gpl.html</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">or from:</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">The Free Software Foundation, Inc., 59 Temple Place - Suite 330, </span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">Boston, MA  02111-1307, USA.</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">If you wish to use or incorporate this program (or parts of it) into </span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">other software that does not meet the GNU General Public License </span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">conditions contact the author to request permission.</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">David G. Tarboton  </span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">Utah State University </span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">8200 Old Main Hill </span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">Logan, UT 84322-8200 </span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">USA </span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">http://www.engineering.usu.edu/dtarb/ </span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">email:  dtarb@usu.edu </span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">//  This software is distributed from http://hydrology.usu.edu/taudem/</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">// 1/25/14.  Modified to use shapelib by Chris George</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &lt;mpi.h&gt;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;queue&gt;</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &quot;commonLib.h&quot;</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#include &quot;linearpart.h&quot;</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &quot;createpart.h&quot;</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &quot;tiffIO.h&quot;</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &quot;tardemlib.h&quot;</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &quot;linklib.h&quot;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &quot;streamnet.h&quot;</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="preprocessor">#include &lt;limits&gt;</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keyword">using namespace </span>std;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;SHPHandle shp1;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;DBFHandle dbf1;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="keywordtype">int</span> linknoIdx, dslinknoIdx, uslinkno1Idx, uslinkno2Idx, dsnodeidIdx, orderIdx, lengthIdx, magnitudeIdx, dscontareaIdx, </div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    dropIdx, slopeIdx, straightlengthIdx, uscontareaIdx, wsnoIdx, doutendIdx, doutstartIdx, doutmidIdx;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="keywordtype">void</span> createStreamNetShapefile(<span class="keywordtype">char</span> *streamnetshp)</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;{</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    shp1 = SHPCreate(streamnetshp, SHPT_ARC);</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordtype">char</span> streamnetdbf[MAXLN];</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    nameadd(streamnetdbf, streamnetshp, <span class="stringliteral">&quot;.dbf&quot;</span>);</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    dbf1 = DBFCreate(streamnetdbf);</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    linknoIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;LINKNO&quot;</span>,FTInteger,6,0);</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    dslinknoIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;DSLINKNO&quot;</span>,FTInteger,6,0);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    uslinkno1Idx = DBFAddField(dbf1,<span class="stringliteral">&quot;USLINKNO1&quot;</span>,FTInteger,6,0);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    uslinkno2Idx = DBFAddField(dbf1,<span class="stringliteral">&quot;USLINKNO2&quot;</span>,FTInteger,6,0);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    dsnodeidIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;DSNODEID&quot;</span>,FTInteger,12,0);</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    orderIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;Order&quot;</span>,FTInteger,6,0);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    lengthIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;Length&quot;</span>,FTDouble,16,1);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    magnitudeIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;Magnitude&quot;</span>,FTInteger,6,0);</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    dscontareaIdx  = DBFAddField(dbf1,<span class="stringliteral">&quot;DS_Cont_Area&quot;</span>,FTDouble,16,1);</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    dropIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;Drop&quot;</span>,FTDouble,16,2);</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    slopeIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;Slope&quot;</span>,FTDouble,16,12);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    straightlengthIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;Straight_Length&quot;</span>,FTDouble,16,1);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    uscontareaIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;US_Cont_Area&quot;</span>,FTDouble,16,1);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    wsnoIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;WSNO&quot;</span>,FTInteger,6,0);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    doutendIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;DOUT_END&quot;</span>,FTDouble,16,1);</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    doutstartIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;DOUT_START&quot;</span>,FTDouble,16,1);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    doutmidIdx = DBFAddField(dbf1,<span class="stringliteral">&quot;DOUT_MID&quot;</span>,FTDouble,16,1);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;}</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">// Write shape from tardemlib.cpp</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="keywordtype">int</span> reachshape(<span class="keywordtype">long</span> *cnet,<span class="keywordtype">float</span> *lengthd, <span class="keywordtype">float</span> *elev, <span class="keywordtype">float</span> *area, <span class="keywordtype">double</span> *pointx, <span class="keywordtype">double</span> *pointy, <span class="keywordtype">long</span> np)</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;{</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">// Function to write stream network shapefile</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="keywordtype">int</span> nVertices;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="keywordflow">if</span> (np &lt; 2) {<span class="comment">//singleton - will be duplicated</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        nVertices = 2;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    }</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        nVertices = np;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    }</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;     </div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <span class="keywordtype">double</span> *mypointx = <span class="keyword">new</span> <span class="keywordtype">double</span>[nVertices];</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="keywordtype">double</span> *mypointy = <span class="keyword">new</span> <span class="keywordtype">double</span>[nVertices];</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordtype">double</span> x,y,length,glength,x1,y1,xlast,ylast,usarea,dsarea,dslast,dl,drop,slope;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="keywordtype">int</span> istart,iend,j;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    istart=cnet[1];  <span class="comment">//  start coord for first link</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    iend=cnet[2];<span class="comment">//  end coord for first link</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    x1=pointx[0];</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    y1=pointy[0];</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    length=0.;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    xlast=x1;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    ylast=y1;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    usarea=area[0];</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    dslast=usarea;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    dsarea=usarea;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordtype">long</span> prt = 0;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="keywordflow">for</span>(j=0; j&lt;np; j++)  <span class="comment">//  loop over points</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    {</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        x=pointx[j];</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        y=pointy[j];</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="comment">// we have to reverse order of pointx and pointy arrays to finish up with </span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="comment">// the point with point index 0 in the shape being the outlet point</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <span class="comment">// (which is for backwards compatibility with previous versions of TauDEM)</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keywordtype">int</span> i = np - (j + 1);</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        mypointx[i] = x;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        mypointy[i] = y;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        dl=sqrt((x-xlast)*(x-xlast)+(y-ylast)*(y-ylast));</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="keywordflow">if</span>(dl &gt; 0.)</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        {</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;            length=length+dl;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;            xlast=x;  ylast=y;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;            dsarea=dslast;   <span class="comment">// keeps track of last ds area</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;            dslast=area[j];</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        }</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    }</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    drop=elev[0]-elev[np-1];</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    slope=0.;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordtype">float</span> dsdist=lengthd[np-1];</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordtype">float</span> usdist=lengthd[0];</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keywordtype">float</span> middist=(dsdist+usdist)*0.5;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">if</span>(length &gt; 0.)slope=drop/length;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    glength=sqrt((x-x1)*(x-x1)+(y-y1)*(y-y1));</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="comment">// ensure at least two points (assuming have at least 1) by repeating singleton</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keywordflow">if</span> (np &lt; 2) {</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        mypointx[1] = mypointx[0];</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        mypointy[1] = mypointy[0];</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    }</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    SHPObject *shape = SHPCreateSimpleObject(</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        SHPT_ARC,                       <span class="comment">// type</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        nVertices,                      <span class="comment">// number of vertices</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        mypointx,                       <span class="comment">// X values</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        mypointy,                       <span class="comment">// Y values</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        NULL);                          <span class="comment">// Z values</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    </div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="comment">// -1 position means append</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="keywordtype">int</span> ishape = SHPWriteObject(shp1, -1, shape);</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    SHPDestroyObject(shape);</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="keyword">delete</span>[] mypointx;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keyword">delete</span>[] mypointy;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordtype">int</span> res;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    res = DBFWriteIntegerAttribute(dbf1, ishape, linknoIdx, (<span class="keywordtype">int</span>)cnet[0]);</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    res *= DBFWriteIntegerAttribute(dbf1, ishape, dslinknoIdx, (<span class="keywordtype">int</span>)cnet[3]);</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    res *= DBFWriteIntegerAttribute(dbf1, ishape, uslinkno1Idx, (<span class="keywordtype">int</span>)cnet[4]);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    res *= DBFWriteIntegerAttribute(dbf1, ishape, uslinkno2Idx, (<span class="keywordtype">int</span>)cnet[5]);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    res *= DBFWriteIntegerAttribute(dbf1, ishape, dsnodeidIdx, (<span class="keywordtype">int</span>)cnet[7]);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    res *= DBFWriteIntegerAttribute(dbf1, ishape, orderIdx, (<span class="keywordtype">int</span>)cnet[6]);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    res *= DBFWriteDoubleAttribute(dbf1, ishape, lengthIdx, length);</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    res *= DBFWriteIntegerAttribute(dbf1, ishape, magnitudeIdx, (<span class="keywordtype">int</span>)cnet[8]);</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    res *= DBFWriteDoubleAttribute(dbf1, ishape, dscontareaIdx, dsarea);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    res *= DBFWriteDoubleAttribute(dbf1, ishape, dropIdx, drop);</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    res *= DBFWriteDoubleAttribute(dbf1, ishape, slopeIdx, slope);</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    res *= DBFWriteDoubleAttribute(dbf1, ishape, straightlengthIdx, glength);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    res *= DBFWriteDoubleAttribute(dbf1, ishape, uscontareaIdx, usarea);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    res *= DBFWriteIntegerAttribute(dbf1, ishape, wsnoIdx, (<span class="keywordtype">int</span>)cnet[0]);</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    res *= DBFWriteDoubleAttribute(dbf1, ishape, doutendIdx, dsdist);</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    res *= DBFWriteDoubleAttribute(dbf1, ishape, doutstartIdx, usdist);</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    res *= DBFWriteDoubleAttribute(dbf1, ishape, doutmidIdx, middist);</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keywordflow">if</span> (res == 0) { <span class="comment">// at least one of the write attribute functions returned 0, ie failed</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        fprintf(stderr, <span class="stringliteral">&quot;Problem writing to stream network dbf file&quot;</span>);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        fflush(stderr);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    }</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;}</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="keyword">struct </span>Slink{</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="keywordtype">long</span> id;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordtype">short</span> dest;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;};</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="keywordtype">int</span> netsetup(<span class="keywordtype">char</span> *pfile,<span class="keywordtype">char</span> *srcfile,<span class="keywordtype">char</span> *ordfile,<span class="keywordtype">char</span> *ad8file,<span class="keywordtype">char</span> *elevfile,<span class="keywordtype">char</span> *treefile, <span class="keywordtype">char</span> *coordfile, </div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;             <span class="keywordtype">char</span> *outletshapefile, <span class="keywordtype">char</span> *wfile, <span class="keywordtype">char</span> *streamnetshp, <span class="keywordtype">long</span> useOutlets, <span class="keywordtype">long</span> ordert, <span class="keywordtype">bool</span> verbose) </div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;{</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="comment">// MPI Init section</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    MPI_Init(NULL,NULL);{</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keywordtype">int</span> rank,size;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        MPI_Comm_rank(MCW,&amp;rank);</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        MPI_Comm_size(MCW,&amp;size);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="keywordflow">if</span>(rank==0)</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        {</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                printf(<span class="stringliteral">&quot;StreamNet version %s\n&quot;</span>,TDVERSION);</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                fflush(stdout);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        }</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        <span class="comment">//  Used throughout</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        <span class="keywordtype">float</span> tempFloat;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="keywordtype">long</span> tempLong;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        <span class="keywordtype">short</span> tempShort;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="comment">//  Keep track of time</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="keywordtype">double</span> begint = MPI_Wtime();</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <span class="comment">//  *** initiate src grid partition from src</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        tiffIO srcIO(srcfile, SHORT_TYPE);  </div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="keywordtype">long</span> TotalX = srcIO.getTotalX();</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keywordtype">long</span> TotalY = srcIO.getTotalY();</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="keywordtype">double</span> dx = srcIO.getdx();</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="keywordtype">double</span> dy = srcIO.getdy();</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <span class="keywordtype">double</span> diag=sqrt((dx*dx)+(dy*dy));</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        <span class="comment">//if(rank==0)</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <span class="comment">//{</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="comment">//  float timeestimate=(1e-4*TotalX*TotalY/pow((double) size,0.2))/60+1;  // Time estimate in minutes</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        <span class="comment">//  fprintf(stderr,&quot;This run may take on the order of %.0f minutes to complete.\n&quot;,timeestimate);</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="comment">//  fprintf(stderr,&quot;This estimate is very approximate. \nRun time is highly uncertain as it depends on the complexity of the input data \nand speed and memory of the computer. This estimate is based on our testing on \na dual quad core Dell Xeon E5405 2.0GHz PC with 16GB RAM.\n&quot;);</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="comment">//  fflush(stderr);</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="comment">//}</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <span class="comment">//Create partition and read data</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        tdpartition *src;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        src = CreateNewPartition(srcIO.getDatatype(), TotalX, TotalY, dx, dy, srcIO.getNodata());</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="keywordtype">int</span> nx = src-&gt;getnx();</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <span class="keywordtype">int</span> ny = src-&gt;getny();</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="keywordtype">int</span> xstart, ystart;  </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        src-&gt;localToGlobal(0, 0, xstart, ystart);  </div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        srcIO.read((<span class="keywordtype">long</span>)xstart, (<span class="keywordtype">long</span>)ystart, (<span class="keywordtype">long</span>)ny, (<span class="keywordtype">long</span>)nx, src-&gt;getGridPointer());</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="comment">//  *** initiate flowdir grid partition from dirfile</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        tiffIO dirIO(pfile, SHORT_TYPE);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        <span class="keywordflow">if</span>(!dirIO.compareTiff(srcIO)){</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;            printf(<span class="stringliteral">&quot;pfile and src files not the same size. Exiting \n&quot;</span>);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;            MPI_Abort(MCW,4);</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        }</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <span class="comment">//Create partition and read data</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        tdpartition *flowDir;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        flowDir = CreateNewPartition(dirIO.getDatatype(), TotalX, TotalY, dx, dy, dirIO.getNodata());</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        dirIO.read((<span class="keywordtype">long</span>)xstart, (<span class="keywordtype">long</span>)ystart, (<span class="keywordtype">long</span>)ny, (<span class="keywordtype">long</span>)nx, flowDir-&gt;getGridPointer());</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        tiffIO ad8IO(ad8file, FLOAT_TYPE);</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        <span class="keywordflow">if</span>(!ad8IO.compareTiff(srcIO)){</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            printf(<span class="stringliteral">&quot;ad8file and src files not the same size. Exiting \n&quot;</span>);</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            MPI_Abort(MCW,4);</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        }</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        <span class="comment">//Create partition and read data</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        tdpartition *areaD8;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        areaD8 = CreateNewPartition(ad8IO.getDatatype(), TotalX, TotalY, dx, dy, ad8IO.getNodata());</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        ad8IO.read((<span class="keywordtype">long</span>)xstart, (<span class="keywordtype">long</span>)ystart, (<span class="keywordtype">long</span>)ny, (<span class="keywordtype">long</span>)nx, areaD8-&gt;getGridPointer());</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        tiffIO elevIO(elevfile, FLOAT_TYPE);</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="keywordflow">if</span>(!elevIO.compareTiff(srcIO)){</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;            printf(<span class="stringliteral">&quot;elevfile and src files not the same size. Exiting \n&quot;</span>);</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;            MPI_Abort(MCW,4);</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        }</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        <span class="comment">//Create partition and read data</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        tdpartition *elev;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        elev = CreateNewPartition(elevIO.getDatatype(), TotalX, TotalY, dx, dy, elevIO.getNodata());</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        elevIO.read((<span class="keywordtype">long</span>)xstart, (<span class="keywordtype">long</span>)ystart, (<span class="keywordtype">long</span>)ny, (<span class="keywordtype">long</span>)nx, elev-&gt;getGridPointer());</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="comment">//Create empty partition to store new ID information</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        tdpartition *idGrid;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        idGrid = CreateNewPartition(LONG_TYPE, TotalX, TotalY, dx, dy, MISSINGLONG);</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <span class="comment">//Create empty partition to store number of contributing neighbors</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        tdpartition *contribs;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        contribs = CreateNewPartition(SHORT_TYPE, TotalX, TotalY, dx, dy, MISSINGSHORT);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        <span class="comment">//Create empty partition to stream order</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        tdpartition *wsGrid;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        wsGrid = CreateNewPartition(LONG_TYPE, TotalX, TotalY, dx, dy, MISSINGLONG);</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        makeLinkSet();</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        <span class="keywordtype">long</span> i,j,inext,jnext;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="keywordtype">int</span> *xOutlets;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="keywordtype">int</span> *yOutlets;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="keywordtype">int</span> numOutlets=0;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <span class="keywordtype">double</span> *x=NULL;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <span class="keywordtype">double</span> *y=NULL;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="keywordtype">int</span> *ids=NULL;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        <span class="comment">// Read outlets </span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <span class="keywordflow">if</span>( useOutlets == 1) {</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            <span class="keywordflow">if</span>(rank==0){</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                <span class="keywordflow">if</span>(readoutlets(outletshapefile, &amp;numOutlets, x, y,ids) !=0){</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                    printf(<span class="stringliteral">&quot;Exiting \n&quot;</span>);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                    MPI_Abort(MCW,5);</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                }<span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                    MPI_Bcast(&amp;numOutlets, 1, MPI_INT, 0, MCW);</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                    MPI_Bcast(x, numOutlets, MPI_DOUBLE, 0, MCW);</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                    MPI_Bcast(y, numOutlets, MPI_DOUBLE, 0, MCW);</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                    MPI_Bcast(ids, numOutlets, MPI_INT, 0, MCW);</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                }</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            }</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                MPI_Bcast(&amp;numOutlets, 1, MPI_INT, 0, MCW);</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                <span class="comment">//x = (double*) malloc( sizeof( double ) * numOutlets );</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                <span class="comment">//y = (double*) malloc( sizeof( double ) * numOutlets );</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                x = <span class="keyword">new</span> <span class="keywordtype">double</span>[numOutlets];</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                y = <span class="keyword">new</span> <span class="keywordtype">double</span>[numOutlets];</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                ids = <span class="keyword">new</span> <span class="keywordtype">int</span>[numOutlets];</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                MPI_Bcast(x, numOutlets, MPI_DOUBLE, 0, MCW);</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                MPI_Bcast(y, numOutlets, MPI_DOUBLE, 0, MCW);</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                MPI_Bcast(ids, numOutlets, MPI_INT, 0, MCW);</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            }</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;            xOutlets = <span class="keyword">new</span> <span class="keywordtype">int</span>[numOutlets];</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;            yOutlets = <span class="keyword">new</span> <span class="keywordtype">int</span>[numOutlets];</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="comment">//  Loop over all points in shapefile.  If they are in the partition (after conversion from </span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        <span class="comment">//   geographic to global, then global to partition coordinates) set the idGrid to hold ids value</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        <span class="comment">//   leaving the remainder of idGrid to no data</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            <span class="keywordflow">for</span>(i = 0; i&lt;numOutlets;i++){</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                ad8IO.geoToGlobalXY(x[i], y[i], xOutlets[i], yOutlets[i]);</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                <span class="keywordtype">int</span> xlocal, ylocal;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                idGrid-&gt;globalToLocal(xOutlets[i], yOutlets[i],xlocal,ylocal);</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                <span class="keywordflow">if</span>(idGrid-&gt;isInPartition(xlocal,ylocal)){   <span class="comment">//xOutlets[i], yOutlets[i])){</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                    idGrid-&gt;setData(xlocal,ylocal,(<span class="keywordtype">long</span>)ids[i]);  <span class="comment">//xOutlets[i], yOutlets[i], (long)ids[i]);</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                }</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;            }</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            idGrid-&gt;share();</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        }</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        <span class="comment">// Timer read time</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        <span class="keywordtype">double</span> readt = MPI_Wtime();</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        <span class="keywordflow">if</span>(verbose)  <span class="comment">// debug writes</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        {</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            printf(<span class="stringliteral">&quot;Files read\n&quot;</span>);</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            printf(<span class="stringliteral">&quot;Process: %d, TotalX: %d, TotalY: %d\n&quot;</span>,rank,TotalX,TotalY);</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;            printf(<span class="stringliteral">&quot;Process: %d, nx: %d, ny: %d\n&quot;</span>,rank,nx,ny);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            printf(<span class="stringliteral">&quot;Process: %d, xstart: %d, ystart: %d\n&quot;</span>,rank,xstart,ystart);</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;            printf(<span class="stringliteral">&quot;Process: %d, numOutlets: %d\n&quot;</span>,rank,numOutlets);</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            fflush(stdout);</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        }</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment">//  Block to evaluate distance to outlet</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        <span class="comment">//Create empty partition to store lengths</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        tdpartition *lengths;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        lengths = CreateNewPartition(FLOAT_TYPE, TotalX, TotalY, dx, dy, MISSINGFLOAT);</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        src-&gt;share();</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        flowDir-&gt;share();</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="keywordflow">if</span>(rank==0)</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        {</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;            fprintf(stderr,<span class="stringliteral">&quot;Evaluating distances to outlet\n&quot;</span>);</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            fflush(stderr);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        }</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="comment">//  Initialize queue and contribs partition </span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        queue &lt;node&gt; que;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment">// Initialize queue for links that will be sent.</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        queue &lt;Slink&gt; linkQ;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <span class="keywordtype">long</span> Sup = 0;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="keywordtype">long</span> Sdown = 0;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        Slink temp;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        node t;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        <span class="keywordtype">int</span> p;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        <span class="keywordflow">for</span>(j=0;j&lt;ny;++j){</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;            <span class="keywordflow">for</span>(i=0;i&lt;nx;++i){</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                <span class="comment">// If I am on stream and my downslope neighbor is on stream contribs is 1</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                <span class="comment">// If I am on stream and my downslope neighbor is off stream contribs is 0 because </span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                <span class="comment">//  I am at the end of a stream</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                <span class="keywordflow">if</span>(!src-&gt;isNodata(i,j) &amp;&amp; src-&gt;getData(i,j,tempShort)&gt;0 &amp;&amp; !flowDir-&gt;isNodata(i,j))</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                {</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                    p=flowDir-&gt;getData(i,j,tempShort);</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                    inext=i+d1[p];</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                    jnext=j+d2[p];</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;                    <span class="keywordflow">if</span>(!src-&gt;isNodata(inext,jnext) &amp;&amp; src-&gt;getData(inext,jnext,tempShort)&gt;0 &amp;&amp; !flowDir-&gt;isNodata(inext,jnext))</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                        contribs-&gt;setData(i,j,(<span class="keywordtype">short</span>)1);<span class="comment">//addData? What if it is a junction and has more floing into it?</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                    {</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                        contribs-&gt;setData(i,j,(<span class="keywordtype">short</span>)0);</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                        t.x=i;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                        t.y=j;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                        que.push(t);</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                    }</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                }</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;            }</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        }</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">// while loop where each process empties its que, then shares border info, and repeats till everyone is done</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        <span class="keywordtype">bool</span> finished=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        <span class="keywordtype">int</span> m;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        <span class="comment">//int totalP=0;</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        <span class="keywordflow">while</span>(!finished){</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            contribs-&gt;clearBorders();  </div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            <span class="keywordflow">while</span>(!que.empty()){</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                t=que.front(); </div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                i=t.x; </div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                j=t.y;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                que.pop();</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                p=flowDir-&gt;getData(i,j,tempShort);</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                <span class="keywordtype">float</span> llength=0.;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;                inext=i+d1[p];</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                jnext=j+d2[p];</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                <span class="keywordflow">if</span>(!lengths-&gt;isNodata(inext,jnext))</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                {</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                    llength += lengths-&gt;getData(inext,jnext,tempFloat);</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                    <span class="keywordflow">if</span>(p==1||p==5)llength=llength+dx;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                    <span class="keywordflow">if</span>(p==3||p==7)llength=llength+dy;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                    <span class="keywordflow">if</span>(p%2==0)llength=llength+diag;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                }</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                lengths-&gt;setData(i,j,llength);</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                <span class="comment">//totalP++;</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                <span class="comment">//  Find if neighbor points to me and reduce its dependency by 1</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                <span class="keywordflow">for</span>(m=1;m&lt;=8;++m){</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                    inext=i+d1[m];</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                    jnext=j+d2[m];</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                    <span class="keywordflow">if</span>(pointsToMe(i,j,inext,jnext,flowDir) &amp;&amp; !src-&gt;isNodata(inext,jnext)  &amp;&amp; src-&gt;getData(inext,jnext,tempShort)&gt;0)</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                    {</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                        contribs-&gt;addToData(inext,jnext,(<span class="keywordtype">short</span>)(-1));</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                        <span class="keywordflow">if</span>(contribs-&gt;isInPartition(inext,jnext) &amp;&amp; contribs-&gt;getData(inext,jnext,tempShort)==0)</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                        {</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                            t.x=inext;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                            t.y=jnext;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                            que.push(t);</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                        }</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                    }</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                }</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;            }</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            <span class="comment">//Pass information across partitions</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            contribs-&gt;addBorders();</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;            lengths-&gt;share();</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;            <span class="comment">//If this created a cell with no contributing neighbors, put it on the queue</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;            <span class="keywordflow">for</span>(i=0; i&lt;nx; i++){</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                <span class="keywordflow">if</span>(contribs-&gt;getData(i, -1, tempShort)!=0 &amp;&amp; contribs-&gt;getData(i, 0, tempShort)==0)</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                {</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                    t.x = i;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                    t.y = 0;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                    que.push(t);</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                }</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                <span class="keywordflow">if</span>(contribs-&gt;getData(i, ny, tempShort)!=0 &amp;&amp; contribs-&gt;getData(i, ny-1, tempShort)==0)</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                {</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                    t.x = i;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                    t.y = ny-1;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                    que.push(t); </div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                }</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            }</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;            <span class="comment">//Check if done</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;            finished = que.empty();</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;            finished = contribs-&gt;ringTerm(finished);</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;        }</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;        <span class="comment">// Timer lengtht</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="keywordtype">double</span> lengthct = MPI_Wtime();</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        <span class="keywordflow">if</span>(rank==0)</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        {</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;            fprintf(stderr,<span class="stringliteral">&quot;Creating links\n&quot;</span>);</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;            fflush(stderr);</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        }</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        <span class="keywordflow">if</span>(verbose)</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;            cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot; Starting block to create links&quot;</span>  &lt;&lt; endl;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="comment">//  Now length partition is evaluated</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="comment">//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="comment">//  Block to create links</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="comment">//  Reinitialize contribs partition</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        <span class="keyword">delete</span> contribs;</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        contribs = CreateNewPartition(SHORT_TYPE, TotalX, TotalY, dx, dy, MISSINGSHORT);</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        <span class="keywordtype">long</span> k = 0;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        <span class="keywordflow">for</span>(j=0;j&lt;ny;++j){</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;            <span class="keywordflow">for</span>(i=0;i&lt;nx;++i){</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                <span class="comment">// If I am on stream add 1 for each neighbor on stream that contribs to me</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                <span class="keywordflow">if</span>(!src-&gt;isNodata(i,j) &amp;&amp; src-&gt;getData(i,j,tempShort)&gt;0 &amp;&amp; !flowDir-&gt;isNodata(i,j))</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                {</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                    <span class="keywordtype">short</span> tempc=0;  </div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                    <span class="keywordflow">for</span>(k=1;k&lt;=8;k++)</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                    {</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                        inext=i+d1[k];</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                        jnext=j+d2[k];</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                        <span class="keywordflow">if</span>(pointsToMe(i,j,inext,jnext,flowDir) &amp;&amp; !src-&gt;isNodata(inext,jnext)  &amp;&amp; src-&gt;getData(inext,jnext,tempShort)&gt;0)</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                        {</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                            tempc=tempc+1;  </div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                        }</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                    }</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                    contribs-&gt;setData(i,j,tempc);</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                    <span class="keywordflow">if</span>(tempc==0)</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                    {</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                        t.x=i;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                        t.y=j;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                        que.push(t);</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                    }</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                }</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;            }</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        }</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="comment">//  Indicate progress by about 10 dots per loop</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        <span class="keywordtype">long</span> nque=que.size();</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        <span class="keywordtype">long</span> deltaque=nque/10+10;  <span class="comment">// + 10 to not give so many dots for small jobs</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        <span class="keywordflow">if</span>(verbose)</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;            cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot;   Starting main link creation loop&quot;</span>  &lt;&lt; endl;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="comment">//XXXXXXXXXXXX  MAIN WHILE LOOP</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment">// While loop where each process empties its que, then shares border info, and repeats till everyone is done</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        finished=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        <span class="keywordflow">while</span>(!finished){</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;            <span class="keywordtype">bool</span> linksToReceive=<span class="keyword">true</span>;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;            nque=que.size(); <span class="comment">//  used for indicating progress</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            contribs-&gt;clearBorders();</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;            <span class="keywordflow">while</span>(!que.empty()){</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                t=que.front();</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                i=t.x;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                j=t.y;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                que.pop();</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                <span class="comment">//if(que.size() &lt; nque)</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                <span class="comment">//{</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                <span class="comment">//  nque=nque-deltaque;</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                <span class="comment">//  fprintf(stderr,&quot;.&quot;);</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                <span class="comment">//  fflush(stderr);</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                <span class="comment">//}</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                <span class="comment">// begin cell processing</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                <span class="keywordtype">short</span> nOrder[8];  <span class="comment">// neighborOrders</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                <span class="keywordtype">short</span> inneighbors[8];  <span class="comment">// inflowing neighbors</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                <span class="keywordtype">bool</span> junction; <span class="comment">// junction set to true/false in newOrder</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                <span class="keywordtype">long</span> Id;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                <span class="comment">//  Count number of grid cells on stream that point to me.  </span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                <span class="comment">// (There will be no more than 8, usually only 0, 1,2 or 3.  The queue and </span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                <span class="comment">// processing order ensures that the necessary results have already been </span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                <span class="comment">//  evaluated for these.  In this case it should be a partially complete link </span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                <span class="comment">//  object referenced by a value in a link object partition).  Number that flow </span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                <span class="comment">//  to cell is k.  Record the order and direction to each. </span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                k=0;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                <span class="keywordflow">for</span>(m=1;m&lt;=8;++m){</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                    inext=i+d1[m];</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                    jnext=j+d2[m];</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                    <span class="keywordflow">if</span>(pointsToMe(i,j,inext,jnext,flowDir) &amp;&amp; !src-&gt;isNodata(inext,jnext) &amp;&amp; src-&gt;getData(inext,jnext,tempShort)&gt;0 &amp;&amp; !idGrid-&gt;isNodata(inext,jnext)){</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                        inneighbors[k]=m;  </div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                        <span class="comment">//  stream orders are stored in lengths grid to save memory</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                        nOrder[k]= (short)lengths-&gt;getData(inext,jnext,tempFloat); </div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                        k=k+1;  <span class="comment">// count inflows</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                    }</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                }</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                <span class="comment">// Determine downslope neighbor</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                <span class="keywordtype">long</span> nextx,nexty;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                p=flowDir-&gt;getData(i,j,tempShort);</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                nextx=t.x+d1[p];</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                nexty=t.y+d2[p];</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                <span class="comment">// Determine if mandatory junction indicated by a value in idGrid</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                <span class="keywordtype">bool</span> mandatoryJunction=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                <span class="keywordtype">long</span> shapeID;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                <span class="keywordflow">if</span>(!idGrid-&gt;isNodata(i,j))</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                {</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                    mandatoryJunction=<span class="keyword">true</span>;</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                    shapeID=idGrid-&gt;getData(i,j,shapeID);</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                }</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                <span class="comment">//- determine if terminal link by if downslope neighbor is out of domain</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                <span class="keywordtype">bool</span> terminal = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                <span class="keywordflow">if</span>(!src-&gt;hasAccess(nextx,nexty)  || src-&gt;isNodata(nextx,nexty) </div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                    || (src-&gt;getData(nextx,nexty,tempShort) != 1))</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                    terminal = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                <span class="comment">//  instantiate point</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                point* addPoint;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                addPoint = initPoint(elev,areaD8,lengths,i,j);</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                <span class="comment">//  Case for start of flow path</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                <span class="keywordflow">if</span>(k==0){</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                    <span class="comment">//  This is the start of a stream - instantiate new link</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                    streamlink *thisLink;</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                    thisLink = createLink(-1, -1, -1, addPoint); <span class="comment">//,1); //, dx,dy);</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                    <span class="keywordtype">long</span> u1= thisLink-&gt;Id;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                    idGrid-&gt;setData(i,j, u1);</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                    wsGrid-&gt;setData(i,j, u1);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                    lengths-&gt;setData(i,j,(<span class="keywordtype">float</span>)thisLink-&gt;order);</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                    <span class="comment">//  Handle mandatory junction</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                    <span class="keywordflow">if</span>(mandatoryJunction){</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                        appendPoint(u1, addPoint);</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                        thisLink-&gt;shapeId = shapeID;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                        <span class="keywordflow">if</span>(!terminal){</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                            streamlink *newLink;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                            newLink = createLink(u1,-1,-1, addPoint); <span class="comment">//, 1); //, dx,dy);</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                            newLink-&gt;order =  1;    </div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                            setDownLinkId(u1,newLink-&gt;Id);      </div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                            newLink-&gt;magnitude = 1;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                            terminateLink(u1);</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                            idGrid-&gt;setData(i,j,newLink-&gt;Id);</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                            <span class="comment">//  Here idGrid and wsGrid intentionally out of sync</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                            <span class="comment">//  idGrid to be used to retrieve upstream link for next cell down</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                            <span class="comment">//  wsGrid used to hold the id for delineation of watersheds which </span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                            <span class="comment">//  is the link that ends at this point</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                        }</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(terminal){  <span class="comment">// handle terminal that is not mandatory junction</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                        appendPoint(u1, addPoint);</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                    }</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                }</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                <span class="comment">//  Case for ongoing flow path with single inflow</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(k==1){</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                    <span class="keywordtype">long</span> u1=idGrid-&gt;getData(i+d1[inneighbors[0]],j+d2[inneighbors[0]],tempLong);</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                    appendPoint(u1, addPoint);</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                    streamlink *thisLink;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                    <span class="comment">//TODO DGT Thinks</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                    <span class="comment">// thisLink=u1;  for efficiency</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                    thisLink=FindLink(u1);</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                    <span class="comment">//cout &lt;&lt; &quot;append done&quot;  &lt;&lt; endl;</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                    idGrid-&gt;setData(i,j,u1);</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                    wsGrid-&gt;setData(i,j,u1);</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                    lengths-&gt;setData(i,j,(<span class="keywordtype">float</span>)nOrder[0]);</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                    <span class="comment">//  Handle mandatory junction case</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                    <span class="keywordflow">if</span>(mandatoryJunction){</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                        thisLink-&gt;shapeId = shapeID;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                        <span class="keywordflow">if</span>(!terminal){</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                            streamlink *newLink;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                            newLink = createLink(u1,-1,-1, addPoint); <span class="comment">//, 1); //, dx,dy);</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                            newLink-&gt;order =  thisLink-&gt;order;  </div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                            setDownLinkId(u1,newLink-&gt;Id);      </div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                            newLink-&gt;magnitude = thisLink-&gt;magnitude;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                            terminateLink(u1);</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                            idGrid-&gt;setData(i,j,newLink-&gt;Id);</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                            <span class="comment">//  TODO Here need to assign WSNO = -1</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                        }</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                    }</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                }</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                <span class="comment">// Case for multiple inflows</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(k&gt;1){</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                    <span class="comment">//  rank incoming flow paths from highest to lowest order and process in this order</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                    <span class="comment">//cout &lt;&lt; &quot;k&gt;1 junction: &quot;  &lt;&lt; k &lt;&lt; endl;</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                    <span class="comment">//Dans Code to sort the two largest to the bottom of the list</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                    <span class="keywordtype">short</span> temp;</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> a=0;a&lt;2;++a){</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> b=0;b&lt;k-1;++b){</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                            <span class="keywordflow">if</span>(nOrder[b]&gt;nOrder[b+1]){</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                                temp=nOrder[b];</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                                nOrder[b]=nOrder[b+1];</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                                nOrder[b+1]=temp;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                                temp = inneighbors[b];</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                                inneighbors[b] = inneighbors[b+1];</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                                inneighbors[b+1] = temp;<span class="comment">//keep track of where they came from. </span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                            }</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                        }</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                    }   </div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                    <span class="comment">// Determine order out</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                    <span class="keywordtype">short</span> oOut;<span class="comment">//if the last two have the same order, there is a junction, so bump the order</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                    <span class="keywordflow">if</span>(nOrder[k-2]==nOrder[k-1]){</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                            <span class="comment">//junction=true;</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                        oOut=nOrder[k-1]+1;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                    }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                        oOut=nOrder[k-1];</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                    }</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;                    <span class="keywordtype">long</span> u1, u2;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;                    u1 = idGrid-&gt;getData(i+d1[inneighbors[k-1]],j+d2[inneighbors[k-1]],tempLong);</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;                    u2 = idGrid-&gt;getData(i+d1[inneighbors[k-2]],j+d2[inneighbors[k-2]],tempLong);</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                    appendPoint(u1, addPoint);</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                    appendPoint(u2, addPoint);</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                    streamlink *newLink;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                    newLink = createLink(u1,u2,-1,addPoint); <span class="comment">//,1); //,dx,dy);</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                    newLink-&gt;order = oOut;</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                    setDownLinkId(u1,newLink-&gt;Id);</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                    setDownLinkId(u2,newLink-&gt;Id);</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                    newLink-&gt;magnitude = getMagnitude(u1) + getMagnitude(u2);</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;                    </div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                    <span class="comment">//  TODO add WSNO = -1</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;                    terminateLink(u1);</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;                    terminateLink(u2);</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;                    <span class="comment">//  Handle remaining incoming flow paths</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                    <span class="keywordflow">for</span>(m=2; m&lt;k; m++)   <span class="comment">//  Loop is only entered if k&gt;=3</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;                    {</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                        u1 = newLink-&gt;Id;</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                        u2 = idGrid-&gt;getData(i+d1[inneighbors[k-m-1]],j+d2[inneighbors[k-m-1]],tempLong);</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;                        appendPoint(u1, addPoint);</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;                        appendPoint(u2, addPoint);</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                        <span class="comment">// create a new link</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;                        newLink = createLink(u1,u2,-1,addPoint); <span class="comment">//,1);  //,dx,dy);</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;                        <span class="comment">//  set order of new link as order out</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                        newLink-&gt;order = oOut;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                        <span class="comment">//  set u1 to previously created link</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                        setDownLinkId(u1, newLink-&gt;Id);</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                        setDownLinkId(u2, newLink-&gt;Id);</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                        newLink-&gt;magnitude = getMagnitude(u1) + getMagnitude(u2);</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                        </div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                        <span class="comment">//  TODO add WSNO = -1</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                        terminateLink(u1);</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                        terminateLink(u2);</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;                    }</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                    idGrid-&gt;setData(i,j,newLink-&gt;Id);<span class="comment">// Set the idGrid to the new link ID?</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                    wsGrid-&gt;setData(i,j,newLink-&gt;Id);</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                    lengths-&gt;setData(i,j,(<span class="keywordtype">float</span>)oOut);</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                    <span class="keywordflow">if</span>(mandatoryJunction){</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                        <span class="comment">// create a zero length link to the mandatory junction</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                        u1 = newLink-&gt;Id;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                        appendPoint(u1, addPoint);</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                        newLink-&gt;shapeId=shapeID;</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                        <span class="comment">//  TODO assign u1 to WSNO</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                        <span class="keywordflow">if</span>(!terminal){</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;                            newLink = createLink(u1,-1,-1,addPoint); <span class="comment">//,1); //,dx,dy);</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;                            <span class="comment">//  set order of new link as order out</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;                            newLink-&gt;order = oOut;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;                            <span class="comment">//  set u1 to previously created link</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                            setDownLinkId(u1, newLink-&gt;Id);</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                            newLink-&gt;magnitude = getMagnitude(u1);</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;                            idGrid-&gt;setData(i,j,newLink-&gt;Id);<span class="comment">// Set the idGrid to the new link ID?</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;                            <span class="comment">//  TODO assign -1 to WNSO</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                        }</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(terminal){</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                        u1 = newLink-&gt;Id;</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                        appendPoint(u1, addPoint);</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                        <span class="comment">//  TODO assign u1 to WSNO</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                    }</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                }</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                <span class="comment">//Check if down neighbor needs to be added to que</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                contribs-&gt;addToData(nextx,nexty,(<span class="keywordtype">short</span>)-1);</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                <span class="keywordflow">if</span>(contribs-&gt;isInPartition(nextx,nexty))</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                {</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                    <span class="keywordflow">if</span>(contribs-&gt;getData(nextx, nexty, tempShort) == 0 ){</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                        t.x=nextx;</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                        t.y=nexty;</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                        que.push(t);</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                    }</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                }</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                <span class="comment">//  IF link is to be sent</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                <span class="comment">//     ID which process to go to (rank - 1 or rank + 1)</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                <span class="comment">//     Add id to a list for that process</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                <span class="comment">//     count number for that process</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                <span class="keywordflow">else</span> </div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                {</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                    <span class="comment">//  Package up the link that either began or is in process at cell i,j and send to downstream partition</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                    <span class="comment">//  Link has to be sent</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                    <span class="keywordflow">if</span>(nexty&lt;0 &amp;&amp; rank&gt;0)  <span class="comment">// up</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                    {</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                        temp.id = idGrid-&gt;getData(i,j,tempLong);</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;                        temp.dest = rank-1;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;                        linkQ.push(temp);</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                        Sup++;</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;                    }</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                    <span class="keywordflow">if</span>(nexty&gt;=ny &amp;&amp; rank &lt; size-1)</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;                    {</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;                        temp.id = idGrid-&gt;getData(i,j,tempLong);</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;                        temp.dest = rank+1;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                        linkQ.push(temp);</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                        Sdown++;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;                    }</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;                }</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;            }</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;            <span class="keywordflow">if</span>(verbose)</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            {</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot; End link creation pass - about to share&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                MPI_Status stat;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                <span class="keywordtype">int</span> messageFlag = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                MPI_Iprobe(MPI_ANY_SOURCE, MPI_ANY_TAG, MCW, &amp;messageFlag, &amp;stat);</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                <span class="keywordflow">if</span>(messageFlag == <span class="keyword">true</span>){</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                        cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot;: I have a message waiting before I try to pass links!!!&quot;</span> &lt;&lt; stat.MPI_TAG &lt;&lt; endl;</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                        MPI_Abort(MCW,4);</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                }</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                MPI_Barrier(MCW);</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;            }</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="comment">//  Block to swap links</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;            <span class="keywordflow">if</span>(size &gt; 1)</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;            {</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                <span class="keywordtype">long</span> numRecv;</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                MPI_Status stat;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                <span class="keywordflow">if</span>(rank &lt; size-1){<span class="comment">//only send down</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                    MPI_Send(&amp;Sdown,1,MPI_LONG,rank+1,0,MCW);<span class="comment">//send message saying done</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j =0; j&lt;Sdown; j++){</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                        temp.id = linkQ.front().id;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                        temp.dest = linkQ.front().dest;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                        linkQ.pop();<span class="comment">//all an the q should go to the same dest.</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                        <span class="keywordflow">while</span>(temp.dest != rank+1){</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                            linkQ.push(temp);</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                            temp.id = linkQ.front().id;</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                            temp.dest = linkQ.front().dest;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                            linkQ.pop();<span class="comment">//all an the q should go to the same dest.</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                        }</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;                        sendLink(temp.id,temp.dest);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                    }</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                }</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;                <span class="keywordflow">if</span>(rank &gt;0)</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                {</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;                    MPI_Recv(&amp;numRecv,1,MPI_LONG,rank-1,0,MCW,&amp;stat);</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j =0 ;j&lt;numRecv;j++){</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                        recvLink(rank-1);<span class="comment">//recv from up.</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                    }</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                }</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                <span class="keywordflow">if</span>(rank &gt; 0)</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                {</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                    MPI_Send(&amp;Sup,1,MPI_LONG,rank-1,0,MCW);<span class="comment">//send message saying up</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j =0; j&lt;Sup; j++){</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;                        temp.id = linkQ.front().id;</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                        temp.dest = linkQ.front().dest;</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                        linkQ.pop();<span class="comment">//all an the q should go to the same dest.</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                        sendLink(temp.id,temp.dest);</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                    }</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;                }</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                <span class="keywordflow">if</span>(rank &lt; size -1)</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                {</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                    MPI_Recv(&amp;numRecv,1,MPI_LONG,rank+1,0,MCW,&amp;stat);</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0;j &lt; numRecv; j++){</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;                        recvLink(rank+1);<span class="comment">//recv from below.</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                    }</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                }</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                <span class="comment">//MPI_Barrier(MCW);</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;                Sup = 0;</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;                Sdown = 0;</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                </div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                <span class="comment">//MPI_Status stat;</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="comment">//                  int messageFlag = false;</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="comment">//                  MPI_Iprobe(MPI_ANY_SOURCE, MPI_ANY_TAG, MCW, &amp;messageFlag, &amp;stat);</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <span class="comment">//                      if(messageFlag == true){</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="comment">//                          cout &lt;&lt; rank &lt;&lt; &quot;: I have failed to received a message!!!&quot; &lt;&lt; stat.MPI_TAG &lt;&lt; endl;</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="comment">//                          MPI_Abort(MCW,3);</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="comment">//                  }</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                <span class="comment">//MPI_Barrier(MCW);</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                idGrid-&gt;share();</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                wsGrid-&gt;share();</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                lengths-&gt;share();</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                contribs-&gt;addBorders();</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                <span class="keywordflow">for</span>(i=0; i&lt;nx; i++){<span class="comment">//todo fix this to add passed to queue</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                    <span class="keywordflow">if</span>(contribs-&gt;getData(i, 0, tempShort) == 0 &amp;&amp; contribs-&gt;getData(i,-1,tempShort)!=0) <span class="comment">//may receive flow from more than 1</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                    {</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                        t.x = i;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                        t.y = 0;</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                        que.push(t);</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                    }</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;                    <span class="keywordflow">if</span>(contribs-&gt;getData(i, ny-1, tempShort) == 0 &amp;&amp; contribs-&gt;getData(i,ny,tempShort)!=0)<span class="comment">//only looks at one direction of flow, out of a partition &amp;&amp; idGrid-&gt;isNodata(i,ny-1) &amp;&amp; src-&gt;getData(i,ny-1,tempShort)==1</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;                    {</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;                        t.x = i;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;                        t.y = ny-1;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;                        que.push(t); </div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                    }</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                }</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                finished = que.empty();</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                <span class="comment">//MPI_Barrier(MCW);</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                <span class="keywordtype">int</span> total = 0;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                <span class="keywordtype">int</span> AllSum = 0;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;                <span class="keywordflow">if</span>(!finished)</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                    total = que.size();</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                MPI_Allreduce(&amp;total,&amp;AllSum,1,MPI_INT,MPI_SUM,MCW);</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                <span class="keywordflow">if</span>(AllSum == 0)</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                    finished = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;                    finished = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;                <span class="keywordflow">if</span>(verbose)</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;                {</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;                    cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot; Remaining in partition queue: &quot;</span> &lt;&lt; total &lt;&lt; endl;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                    cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot; Remaining total: &quot;</span> &lt;&lt; AllSum &lt;&lt; endl;</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;                }</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;            }</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;                finished=<span class="keyword">true</span>;  <span class="comment">// For size == 1 no partition loop</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;        }   </div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="comment">//  Now all links have been created</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;        <span class="comment">// Timer</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        <span class="keywordtype">double</span> linkct = MPI_Wtime();</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        <span class="comment">//if(rank == 0)</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        <span class="comment">//{</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        <span class="comment">//  fprintf(stderr,&quot;\nLinks have been created, starting to write links\n&quot;);</span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        <span class="comment">//  fflush(stderr);</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        <span class="comment">//}</span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="comment">//  XXXXXXXXX</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;<span class="comment">//  Block to write link data</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        <span class="keywordflow">if</span>(verbose)</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        {</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;            cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot; Starting to write links&quot;</span>  &lt;&lt; endl;</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;            MPI_Status stat;</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;            <span class="keywordtype">int</span> messageFlag = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;            MPI_Iprobe(MPI_ANY_SOURCE, MPI_ANY_TAG, MCW, &amp;messageFlag, &amp;stat);</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;            <span class="keywordflow">if</span>(messageFlag == <span class="keyword">true</span>){</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                    cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot;: I have failed to received a message!!!&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                    MPI_Abort(MCW,2);</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;            }</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;            MPI_Barrier(MCW);</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;        }</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        <span class="keywordtype">long</span> myNumLinks;</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        <span class="keywordtype">long</span> myNumPoints;</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        <span class="keywordtype">long</span> totalNumLinks;</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        <span class="keywordtype">long</span> totalNumPoints;</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        <span class="keywordtype">long</span> relativePointStart;<span class="comment">//if 9 then line 9 is first to be filled by me</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        <span class="keywordtype">double</span> **PointXY;</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        <span class="keywordtype">float</span> **PointElevArea;</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        <span class="keywordtype">long</span> **LinkIdU1U2DMagShapeidCoords;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        <span class="keywordtype">double</span> **LinkElevUElevDLength;</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        <span class="keywordtype">long</span> *buf;</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        <span class="keywordtype">long</span> *ptr;</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        <span class="keywordtype">int</span> place;</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;        <span class="keywordtype">int</span> bsize = <span class="keyword">sizeof</span>(long)+ MPI_BSEND_OVERHEAD;  </div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        buf = <span class="keyword">new</span> <span class="keywordtype">long</span>[bsize];</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        getNumLinksAndPoints(myNumLinks,myNumPoints);</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        <span class="comment">//MPI_Barrier(MCW);</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        i = 0;</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;        <span class="keywordflow">if</span>(myNumLinks &gt; 0){</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;            LinkIdU1U2DMagShapeidCoords = <span class="keyword">new</span> <span class="keywordtype">long</span>*[myNumLinks];</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;            <span class="keywordflow">for</span>(i=0;i&lt;myNumLinks;i++)</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                LinkIdU1U2DMagShapeidCoords[i] = <span class="keyword">new</span> <span class="keywordtype">long</span>[9];</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;            LinkElevUElevDLength = <span class="keyword">new</span> <span class="keywordtype">double</span>*[myNumLinks];</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;            <span class="keywordflow">for</span>(i = 0;i&lt;myNumLinks;i++) </div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                LinkElevUElevDLength[i] = <span class="keyword">new</span> <span class="keywordtype">double</span>[3];</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;            <span class="keywordflow">if</span>(myNumPoints&gt;0)</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;            {</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                PointXY = <span class="keyword">new</span> <span class="keywordtype">double</span>*[myNumPoints];</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                <span class="keywordflow">for</span>(i=0;i&lt;myNumPoints;i++)</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                    PointXY[i] = <span class="keyword">new</span> <span class="keywordtype">double</span>[2];</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;                PointElevArea = <span class="keyword">new</span> <span class="keywordtype">float</span>*[myNumPoints];</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                <span class="keywordflow">for</span>(i=0;i&lt;myNumPoints;i++)</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                    PointElevArea[i] = <span class="keyword">new</span> <span class="keywordtype">float</span>[3];</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;                setLinkInfo(LinkIdU1U2DMagShapeidCoords,LinkElevUElevDLength,PointXY,PointElevArea,elev,&amp;elevIO);</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;            }</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        }</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;        <span class="keywordtype">int</span> ibuf;</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        <span class="keywordtype">int</span> procNumPoints;</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        <span class="keywordtype">int</span> totalPoints = 0;</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;        <span class="keywordtype">float</span> pbuf[3];</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        <span class="keywordtype">double</span> pbuf1[2];</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        MPI_Status mystatus;</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        </div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        <span class="keywordtype">int</span> numPointsPrinted =0;</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        <span class="keywordtype">int</span> procNumLinks = 0;</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        <span class="keywordtype">long</span> treeBuf[9];</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        <span class="keywordtype">int</span> ilink, ipoint;</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        <span class="keywordflow">if</span>(rank==0){<span class="comment">//open output point file</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;            FILE *fTreeOut;</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;            fTreeOut = fopen(treefile,<span class="stringliteral">&quot;w&quot;</span>);<span class="comment">// process 0 writes all of its stuff</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;            FILE *fout;</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;            fout = fopen(coordfile,<span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;            <span class="comment">//  Open shapefile</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;            createStreamNetShapefile(streamnetshp);</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;            <span class="keywordtype">long</span> ndots=100/size+4;  <span class="comment">// number of dots to print per process</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;            <span class="keywordtype">long</span> nextdot=0;</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;            <span class="keywordtype">long</span> dotinc=myNumLinks/ndots;</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;            <span class="keywordflow">for</span>(ilink=0;ilink&lt;myNumLinks;ilink++){<span class="comment">//only once per link</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                fprintf(fTreeOut,<span class="stringliteral">&quot;\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\n&quot;</span>,LinkIdU1U2DMagShapeidCoords[ilink][0],LinkIdU1U2DMagShapeidCoords[ilink][1],LinkIdU1U2DMagShapeidCoords[ilink][2],LinkIdU1U2DMagShapeidCoords[ilink][3],LinkIdU1U2DMagShapeidCoords[ilink][4],LinkIdU1U2DMagShapeidCoords[ilink][5],LinkIdU1U2DMagShapeidCoords[ilink][6],LinkIdU1U2DMagShapeidCoords[ilink][7],LinkIdU1U2DMagShapeidCoords[ilink][8]);</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                <span class="comment">//fflush(fTreeOut);</span></div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                <span class="keywordtype">long</span> i1=LinkIdU1U2DMagShapeidCoords[ilink][1];</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                <span class="keywordtype">long</span> i2=LinkIdU1U2DMagShapeidCoords[ilink][2];</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                <span class="keywordtype">float</span> *lengthd, *elev, *area;</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                <span class="keywordtype">double</span> *pointx, *pointy;</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;                lengthd = <span class="keyword">new</span> <span class="keywordtype">float</span>[i2-i1+1];</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                elev = <span class="keyword">new</span> <span class="keywordtype">float</span>[i2-i1+1];</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                area = <span class="keyword">new</span> <span class="keywordtype">float</span>[i2-i1+1];</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                pointx = <span class="keyword">new</span> <span class="keywordtype">double</span>[i2-i1+1];</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;                pointy = <span class="keyword">new</span> <span class="keywordtype">double</span>[i2-i1+1];</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                <span class="keywordflow">for</span>(ipoint=i1;ipoint&lt;=i2;ipoint++){</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                    fprintf(fout,<span class="stringliteral">&quot;\t%f\t%f\t%f\t%f\t%f\n&quot;</span>,PointXY[ipoint][0],PointXY[ipoint][1],PointElevArea[ipoint][0],PointElevArea[ipoint][1],PointElevArea[ipoint][2]);</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;                    lengthd[ipoint-i1]=PointElevArea[ipoint][0];</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                    elev[ipoint-i1]=PointElevArea[ipoint][1];</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                    area[ipoint-i1]=PointElevArea[ipoint][2];</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                    pointx[ipoint-i1]=PointXY[ipoint][0];</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                    pointy[ipoint-i1]=PointXY[ipoint][1];</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                }</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                <span class="comment">//  Write shape</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                <span class="keywordtype">long</span> cnet[9];</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iref=0; iref&lt;9; iref++)</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;                    cnet[iref]=LinkIdU1U2DMagShapeidCoords[ilink][iref];</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                reachshape(cnet,lengthd,elev,area,pointx,pointy,i2-i1+1);</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                <span class="keyword">delete</span> lengthd; <span class="comment">// DGT to free memory</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                <span class="keyword">delete</span> elev;</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                <span class="keyword">delete</span> area;</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                <span class="keyword">delete</span> pointx;</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                <span class="keyword">delete</span> pointy;</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                <span class="comment">//if(ilink &gt; nextdot)  // Indicating progress</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                <span class="comment">//{</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                <span class="comment">//  fprintf(stderr,&quot;.&quot;);</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                <span class="comment">//  fflush(stderr);</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                <span class="comment">//  nextdot=nextdot+dotinc;</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                <span class="comment">//}</span></div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;            } <span class="comment">// process 0 recvs data from other processes, writes to file</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;            <span class="keywordflow">if</span>(myNumLinks == 0)</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                numPointsPrinted = 0;</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                numPointsPrinted = LinkIdU1U2DMagShapeidCoords[myNumLinks-1][2]+1;</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;            <span class="keywordflow">for</span>(i=1;i&lt;size;i++){<span class="comment">// send message to next process to wake it up</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                MPI_Send(&amp;ibuf,1,MPI_INT,i,0,MCW);<span class="comment">// get numpoints from that process</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;                MPI_Recv(&amp;procNumLinks,1,MPI_INT,i,0,MCW,&amp;mystatus);<span class="comment">//get points one at a time and print them to file</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                <span class="keywordflow">if</span>(procNumLinks &gt; 0)</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                {</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                    dotinc=procNumLinks/ndots;  <span class="comment">// For tracking progress</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                    nextdot=0;</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                    <span class="keywordflow">for</span>(ilink=0;ilink&lt;procNumLinks;++ilink){</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                        MPI_Recv(&amp;treeBuf,9,MPI_LONG,i,1,MCW,&amp;mystatus);</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                        fprintf(fTreeOut,<span class="stringliteral">&quot;\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\n&quot;</span>,treeBuf[0],treeBuf[1]+numPointsPrinted,treeBuf[2]+numPointsPrinted,treeBuf[3],treeBuf[4],treeBuf[5],treeBuf[6],treeBuf[7],treeBuf[8]);</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                        MPI_Recv(&amp;procNumPoints,1,MPI_INT,i,0,MCW,&amp;mystatus);<span class="comment">//get points one at a time and print them to file</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                <span class="comment">// Variables for shape</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;                        <span class="keywordtype">float</span> *lengthd, *elev, *area;</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;                        <span class="keywordtype">double</span> *pointx, *pointy;</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                        lengthd = <span class="keyword">new</span> <span class="keywordtype">float</span>[procNumPoints];</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                        elev = <span class="keyword">new</span> <span class="keywordtype">float</span>[procNumPoints];</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;                        area = <span class="keyword">new</span> <span class="keywordtype">float</span>[procNumPoints];</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                        pointx = <span class="keyword">new</span> <span class="keywordtype">double</span>[procNumPoints];</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                        pointy = <span class="keyword">new</span> <span class="keywordtype">double</span>[procNumPoints];</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        </div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                        <span class="keywordflow">for</span>(ipoint=0;ipoint&lt;procNumPoints;++ipoint){</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                            MPI_Recv(&amp;pbuf1,2,MPI_DOUBLE,i,1,MCW,&amp;mystatus);</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                            MPI_Recv(&amp;pbuf,3,MPI_FLOAT,i,1,MCW,&amp;mystatus);</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                            fprintf(fout,<span class="stringliteral">&quot;\t%f\t%f\t%f\t%f\t%f\n&quot;</span>,pbuf1[0],pbuf1[1],pbuf[0],pbuf[1],pbuf[2]); </div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;                            lengthd[ipoint]=pbuf[0];</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;                            elev[ipoint]=pbuf[1];</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                            area[ipoint]=pbuf[2];</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                            pointx[ipoint]=pbuf1[0];</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;                            pointy[ipoint]=pbuf1[1];</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;                        }</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;                        <span class="comment">//  Write shape</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;                        reachshape(treeBuf,lengthd,elev,area,pointx,pointy,procNumPoints);</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;                        <span class="keyword">delete</span> lengthd; <span class="comment">// DGT to free memory</span></div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;                        <span class="keyword">delete</span> elev;</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;                        <span class="keyword">delete</span> area;</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                        <span class="keyword">delete</span> pointx;</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;                        <span class="keyword">delete</span> pointy;  </div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                        <span class="comment">//if(ilink &gt; nextdot)  // Indicating progress</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                        <span class="comment">//{</span></div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;                        <span class="comment">//  fprintf(stderr,&quot;.&quot;);</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;                        <span class="comment">//  fflush(stderr);</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;                        <span class="comment">//  nextdot=nextdot+dotinc;</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                        <span class="comment">//}</span></div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                    }</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                <span class="comment">//  DGT moved line below to out of the loop so this only increments on the last link - and only if there is one</span></div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                numPointsPrinted += treeBuf[2]+1;<span class="comment">//might need adjustmetn JJN</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                }</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;            } </div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;            fclose(fTreeOut);</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;            fclose(fout);</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;            SHPClose(shp1);</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;            DBFClose(dbf1);</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;<span class="comment">            shp1.close(streamnetshp);</span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;<span class="comment">            */</span></div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;        }<span class="keywordflow">else</span>{<span class="comment">//other processes send their stuff to process 0</span></div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;            <span class="comment">//first, wait to recieve word from process 0</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;            MPI_Recv(&amp;ibuf,1,MPI_INT,0,0,MCW,&amp;mystatus);<span class="comment">//then, send myNumPoints</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;            MPI_Send(&amp;myNumLinks,1,MPI_INT,0,0,MCW);<span class="comment">//pack up each point into a buffer, and send it</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;            <span class="keywordflow">for</span>(ilink=0;ilink&lt;myNumLinks;++ilink){</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;                treeBuf[0] = LinkIdU1U2DMagShapeidCoords[ilink][0];</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;                treeBuf[1] = LinkIdU1U2DMagShapeidCoords[ilink][1];</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;                treeBuf[2] = LinkIdU1U2DMagShapeidCoords[ilink][2];</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;                treeBuf[3] = LinkIdU1U2DMagShapeidCoords[ilink][3];</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;                treeBuf[4] = LinkIdU1U2DMagShapeidCoords[ilink][4];</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;                treeBuf[5] = LinkIdU1U2DMagShapeidCoords[ilink][5];</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;                treeBuf[6] = LinkIdU1U2DMagShapeidCoords[ilink][6];</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;                treeBuf[7] = LinkIdU1U2DMagShapeidCoords[ilink][7];</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                treeBuf[8] = LinkIdU1U2DMagShapeidCoords[ilink][8];</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;                MPI_Send(&amp;treeBuf,9,MPI_LONG,0,1,MCW);</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;                <span class="keywordtype">int</span> ptsInLink=treeBuf[2]-treeBuf[1]+1;</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;                MPI_Send(&amp;ptsInLink,1,MPI_INT,0,0,MCW);<span class="comment">//pack up each point into a buffer, and send it</span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;                <span class="keywordflow">for</span>(ipoint=treeBuf[1];ipoint&lt;=treeBuf[2];++ipoint){</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;                    pbuf1[0]=PointXY[ipoint][0];</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;                    pbuf1[1]=PointXY[ipoint][1];</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;                    pbuf[0]=PointElevArea[ipoint][0];</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;                    pbuf[1]=PointElevArea[ipoint][1];</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;                    pbuf[2]=PointElevArea[ipoint][2];</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;                    MPI_Send(&amp;pbuf1,2,MPI_DOUBLE,0,1,MCW);</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;                    MPI_Send(&amp;pbuf,3,MPI_FLOAT,0,1,MCW);</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;            <span class="comment">//      MPI_Recv(&amp;ibuf,1,MPI_INT,0,0,MCW,&amp;mystatus);</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;                }</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;            }</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;        }  <span class="comment">// just be sure we&#39;re all here</span></div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        MPI_Barrier(MCW);  <span class="comment">//DGT  This seems necessary for cluster version to work, though not sure why.</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;        <span class="comment">// Timer - link write time</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        <span class="keywordtype">double</span> linkwt = MPI_Wtime();</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        <span class="keywordflow">if</span>(rank==0)  <span class="comment">// Indicating progress</span></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        {</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;            fprintf(stderr,<span class="stringliteral">&quot;\n Calculating watersheds\n&quot;</span>);</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;            fflush(stderr);</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        }</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;        <span class="keywordflow">if</span>(verbose)</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        {</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;            cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot; Starting to calculate watershed&quot;</span>  &lt;&lt; endl;</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;            <span class="keywordtype">int</span> messageFlag;</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;            MPI_Status stat;</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;            MPI_Iprobe(MPI_ANY_SOURCE, MPI_ANY_TAG, MCW, &amp;messageFlag, &amp;stat);</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;            <span class="keywordflow">if</span>(messageFlag == <span class="keyword">true</span>){</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;                    cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot;: I have failed to received a message!!!&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;                    MPI_Abort(MCW,1);</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;            }</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;            MPI_Barrier(MCW);</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        }</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;<span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXX</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="comment">//  Block to calculate watersheds</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        <span class="comment">//long tempLongNodata=MISSINGLONG;</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;        <span class="comment">//short tempShortNodata=MISSINGSHORT;</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;        <span class="comment">//tdpartition *temp111;</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;        <span class="comment">//temp111 = CreateNewPartition(SHORT_TYPE, TotalX, TotalY, dx, dy, MISSINGSHORT);</span></div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        <span class="comment">//for(i=0; i&lt;nx; i++)</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;        <span class="comment">//  for(j=0; j&lt;ny; j++)</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;        <span class="comment">//  {</span></div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;        <span class="comment">//      if(!wsGrid-&gt;isNodata(i,j))</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        <span class="comment">//          temp111-&gt;setData(i,j,(short)wsGrid-&gt;getData(i,j,tempLong));</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;<span class="comment"></span>        <span class="comment">//  }</span></div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;<span class="comment">//      tiffIO ws1IO(&quot;wfile.tif&quot;, SHORT_TYPE,&amp;tempShortNodata,ad8IO);</span></div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;<span class="comment">//      ws1IO.write(xstart, ystart, ny, nx, temp111-&gt;getGridPointer());</span></div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;<span class="comment">//      tiffIO id1IO(&quot;idfile.tif&quot;, LONG_TYPE,&amp;tempLongNodata,ad8IO);</span></div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<span class="comment">//      id1IO.write(xstart, ystart, ny, nx, idGrid-&gt;getGridPointer());</span></div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;        <span class="comment">//Calculate watersheds....</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;        <span class="comment">//  Reinitialize partition to delete leftovers from process above</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;        <span class="keyword">delete</span> contribs;</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        contribs = CreateNewPartition(SHORT_TYPE, TotalX, TotalY, dx, dy, MISSINGSHORT);</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        <span class="comment">//MPI_Barrier(MCW);</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;        <span class="keywordflow">for</span>(j=0;j&lt;ny;++j){</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;            <span class="keywordflow">for</span>(i=0;i&lt;nx;++i){</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;                <span class="comment">// If my downslope neighbor has an id, contribs is 0 and I am ready to evaluate so go on q, else contribs is 1</span></div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;                <span class="keywordflow">if</span>(!flowDir-&gt;isNodata(i,j))</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;                {   <span class="comment">//  Only put on queue to do if it is off the stream network</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                    <span class="keywordflow">if</span>(src-&gt;isNodata(i,j) || src-&gt;getData(i,j,tempShort) &lt; 1) <span class="comment">//idGrid-&gt;isNodata(i,j))  //  Only if it is no data do we have to do anything </span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                    {</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;                        p=flowDir-&gt;getData(i,j,tempShort);</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;                        inext=i+d1[p];</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;                        jnext=j+d2[p];</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;                        <span class="keywordflow">if</span>(src-&gt;hasAccess(inext,jnext))  <span class="comment">//  Only do anything with cells for which we have access to downslope cell</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;                        {</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;                            <span class="keywordflow">if</span>(src-&gt;isNodata(inext,jnext) || src-&gt;getData(inext,jnext,tempShort) &lt; 1){ <span class="comment">//idGrid-&gt;isNodata(inext,jnext))</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;                                contribs-&gt;setData(i,j,(<span class="keywordtype">short</span>)1);  <span class="comment">//  downslope cell not on stream</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;                                wsGrid-&gt;setToNodata(i,j);  <span class="comment">// overwrite grid value that may have been inherited from outlet not on stream</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;                            }</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;                            {</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;                                contribs-&gt;setData(i,j,(<span class="keywordtype">short</span>)0); <span class="comment">//  downslope cell on stream</span></div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;                                t.x=i;</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;                                t.y=j;</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;                                que.push(t);</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;                            }</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;                        }</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;                    }<span class="comment">//  Here on stream</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;                    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ordert==0)  <span class="comment">// Ordert = 0 indicates that all watersheds are to be labeled with the number 1</span></div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;                    {</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;                        tempLong=1;  </div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;                        wsGrid-&gt;setData(i,j,tempLong);</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;                    }</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                }</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;            }</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        }</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        <span class="keywordflow">if</span>(verbose)</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        {</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;            cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot; Watershed initialization complete&quot;</span>  &lt;&lt; endl;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        }</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        <span class="comment">// each process empties its que, then shares border info, and repeats till everyone is done</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        finished=<span class="keyword">false</span>;</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        <span class="keywordflow">while</span>(!finished){</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;            contribs-&gt;clearBorders();</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;            <span class="keywordflow">while</span>(!que.empty()){</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                t=que.front();</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                que.pop();</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;                i = t.x;</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                j = t.y;</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;                p=flowDir-&gt;getData(i,j,tempShort);</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;                inext=i+d1[p];</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                jnext=j+d2[p];</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;                <span class="keywordflow">if</span>(ordert &gt; 0){  <span class="comment">// Ordert &gt; 0 indicates that all watersheds are to be labeled with different numbers</span></div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                    wsGrid-&gt;setData(i,j,wsGrid-&gt;getData(inext,jnext,tempLong));</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;                    <span class="comment">//cout &lt;&lt; tempLong;</span></div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;                }<span class="keywordflow">else</span></div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;                {</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;                    tempLong=1;  <span class="comment">// Ordert = 0 indicates that all watersheds are to be labeled with the number 1</span></div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                    wsGrid-&gt;setData(i,j,tempLong);</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                }</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;                <span class="comment">//  Now find all cells that point to me and decrease contribs and put on queue if necessary</span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;                <span class="keywordflow">for</span>(m=1;m&lt;=8;++m){</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;                    inext=i+d1[m];</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;                    jnext=j+d2[m];</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;                    <span class="keywordflow">if</span>(pointsToMe(i,j,inext,jnext,flowDir))</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;                    {</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;                        contribs-&gt;addToData(inext,jnext,(<span class="keywordtype">short</span>)(-1));</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;                        <span class="keywordflow">if</span>(contribs-&gt;isInPartition(inext,jnext) &amp;&amp; contribs-&gt;getData(inext,jnext,tempShort)==0)</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;                        {</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;                            t.x=inext;</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;                            t.y=jnext;</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;                            que.push(t);</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;                        }</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;                    }</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;                }</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;            }</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;            <span class="comment">//Pass information across partitions</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;            contribs-&gt;addBorders();</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;            wsGrid-&gt;share();</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;            <span class="keywordflow">for</span>(i=0; i&lt;nx; i++){</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;                <span class="keywordflow">if</span>(contribs-&gt;getData(i, -1, tempShort)!=0 &amp;&amp; contribs-&gt;getData(i, 0, tempShort)==0)<span class="comment">//only looks at one direction of flow, out of a partition</span></div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;                {</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;                    t.x = i;</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;                    t.y = 0;</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;                    que.push(t);</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;                }</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                <span class="keywordflow">if</span>(contribs-&gt;getData(i, ny, tempShort) != 0 &amp;&amp; contribs-&gt;getData(i, ny-1, tempShort)==0)<span class="comment">//only looks at one direction of flow, out of a partition</span></div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;                {</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;                    t.x = i;</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;                    t.y = ny-1;</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;                    que.push(t); </div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;                }</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;            }</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;            <span class="comment">//Check if done</span></div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;            finished = que.empty();</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;            finished = contribs-&gt;ringTerm(finished);</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;        }</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;        <span class="comment">// Timer - watershed label time</span></div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;        <span class="keywordtype">double</span> wshedlabt = MPI_Wtime();</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;        <span class="keywordflow">if</span>(verbose)</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;        {</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;            cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot; Writing watershed file&quot;</span>  &lt;&lt; endl;</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;        }</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    </div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;        <span class="keywordtype">long</span> wsGridNodata=MISSINGLONG;</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;        <span class="keywordtype">short</span> ordNodata=MISSINGSHORT;</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        tiffIO wsIO(wfile, LONG_TYPE,&amp;wsGridNodata,ad8IO);</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        wsIO.write(xstart, ystart, ny, nx, wsGrid-&gt;getGridPointer());</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        <span class="keywordflow">if</span>(verbose)</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;        {</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;            cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot; Assigning order array&quot;</span>  &lt;&lt; endl;</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;        }</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;        <span class="comment">//  Use contribs as a short to write out order data that was held in lengths</span></div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;        tempShort=0;</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;        <span class="keywordflow">for</span>(i=0; i&lt;nx; i++)</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;            <span class="keywordflow">for</span>(j=0; j&lt;ny; j++)</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;            {</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;                contribs-&gt;setData(i,j,tempShort);</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;                <span class="keywordflow">if</span>(!lengths-&gt;isNodata(i,j))</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;                    contribs-&gt;setData(i,j,(<span class="keywordtype">short</span>)lengths-&gt;getData(i,j,tempFloat));</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;            }</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;        <span class="keywordflow">if</span>(verbose)</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;        {</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;            cout &lt;&lt; rank &lt;&lt; <span class="stringliteral">&quot; Writing order file&quot;</span>  &lt;&lt; endl;</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;        }</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;        tiffIO ordIO(ordfile, SHORT_TYPE,&amp;ordNodata,ad8IO);</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        ordIO.write(xstart, ystart, ny, nx, contribs-&gt;getGridPointer());</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        </div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;        <span class="comment">// Timer - write time</span></div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;        <span class="keywordtype">double</span> writet = MPI_Wtime();</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;        <span class="keywordtype">double</span> dataRead, lengthc, linkc, linkw, wshedlab,  write, total,tempd;</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;        dataRead = readt-begint;</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    lengthc = lengthct-readt;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;        linkc = linkct-lengthct;</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    linkw = linkwt - linkct;</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    wshedlab = wshedlabt - linkwt;</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;        write = writet-wshedlabt;</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        total = writet - begint;</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        MPI_Allreduce (&amp;dataRead, &amp;tempd, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        dataRead = tempd/size;</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        MPI_Allreduce (&amp;lengthc, &amp;tempd, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        lengthc = tempd/size;</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;        MPI_Allreduce (&amp;linkc, &amp;tempd, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        linkc = tempd/size;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        MPI_Allreduce (&amp;linkw, &amp;tempd, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        linkw = tempd/size;</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;        MPI_Allreduce (&amp;wshedlab, &amp;tempd, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;        wshedlab = tempd/size;</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        MPI_Allreduce (&amp;write, &amp;tempd, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        write = tempd/size;</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        MPI_Allreduce (&amp;total, &amp;tempd, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;        total = tempd/size;</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;        <span class="keywordflow">if</span>( rank == 0)</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;            printf(<span class="stringliteral">&quot;Processors: %d\nRead time: %f\nLength compute time: %f\nLink compute time: %f\nLink write time: %f\nWatershed compute time: %f\nWrite time: %f\nTotal time: %f\n&quot;</span>, size, dataRead, lengthc, linkc, linkw, wshedlab, write,total);</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;    }MPI_Finalize();</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;}</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_743149a2e5a84f022a66541396b6824d.html">preprocess</a></li><li class="navelem"><a class="el" href="../../dir_c5a603dc4ef604e616567644c9e0432f.html">cpp_src</a></li><li class="navelem"><a class="el" href="../../dir_de4c123db9a00eb1452e6ec6a9e67c00.html">TauDEM</a></li><li class="navelem"><b>streamnet.cpp</b></li>
    <li class="footer">Generated on Tue May 24 2016 01:24:17 for SEIMS-2016 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
