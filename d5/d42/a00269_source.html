<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>SEIMS-2016: preprocess/cpp_src/TauDEM/DropAnalysis.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">SEIMS-2016
   &#160;<span id="projectnumber">1.0-beta</span>
   </div>
   <div id="projectbrief">Spatially Explicit Integrated Modeling System</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d5/d42/a00269_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">DropAnalysis.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*  DropAnalysis function that applies a series of thresholds (determined from the input parameters) </span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">  to the input ssa grid and outputs in the drp.txt file the stream drop statistics table.  </span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">  David Tarboton, Dan Watson</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">  Utah State University  </span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">  May 23, 2010 </span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">/*  Copyright (C) 2010  David Tarboton, Utah State University</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">This program is free software; you can redistribute it and/or</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">modify it under the terms of the GNU General Public License </span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">version 2, 1991 as published by the Free Software Foundation.</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">GNU General Public License for more details.</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">A copy of the full GNU General Public License is included in file </span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">gpl.html. This is also available at:</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">http://www.gnu.org/copyleft/gpl.html</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">or from:</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">The Free Software Foundation, Inc., 59 Temple Place - Suite 330, </span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">Boston, MA  02111-1307, USA.</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">If you wish to use or incorporate this program (or parts of it) into </span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">other software that does not meet the GNU General Public License </span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">conditions contact the author to request permission.</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">David G. Tarboton  </span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">Utah State University </span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">8200 Old Main Hill </span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">Logan, UT 84322-8200 </span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">USA </span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">http://www.engineering.usu.edu/dtarb/ </span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">email:  dtarb@usu.edu </span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">//  This software is distributed from http://hydrology.usu.edu/taudem/</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &lt;mpi.h&gt;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;queue&gt;</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#include &quot;commonLib.h&quot;</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &quot;linearpart.h&quot;</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &quot;createpart.h&quot;</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &quot;tiffIO.h&quot;</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &quot;DropAnalysis.h&quot;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keyword">using namespace </span>std;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment">//does the appropriate updates when a junction is found</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keywordtype">void</span> updateAtJunction(<span class="keywordtype">short</span> oOut,<span class="keywordtype">long</span> i, <span class="keywordtype">long</span> ni,<span class="keywordtype">long</span> j, <span class="keywordtype">long</span> nj, <span class="keywordtype">long</span> nx, <span class="keywordtype">long</span> ny, tdpartition *dirData,</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;                      tdpartition *orderOut, tdpartition *elevOut, </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;                      tdpartition *elevData, <span class="keywordtype">bool</span> &amp;newstream,</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;                      <span class="keywordtype">float</span> &amp;s1,<span class="keywordtype">float</span> &amp;s1sq,<span class="keywordtype">float</span> &amp;s2,<span class="keywordtype">float</span> &amp;s2sq,<span class="keywordtype">long</span> &amp;n1,<span class="keywordtype">long</span> &amp;n2){</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="keywordtype">short</span> o;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="keywordtype">float</span> drop;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="keywordtype">float</span> e;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="comment">//simply return if at partition side edge</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">//TODO use either hasaccess or isinpartition functions</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="comment">//if(ni&lt;=0||ni&gt;=nx-1||j&lt;0||j&gt;ny)return;</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="keywordflow">if</span>(!orderOut-&gt;hasAccess(ni,nj))<span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="comment">//simply return if ni,nj doesn&#39;t point to i,j</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordflow">if</span>(!pointsToMe(i,j,ni,nj,dirData) || orderOut-&gt;isNodata(ni,nj))<span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="comment">//get the order of the pointing cell</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    o=orderOut-&gt;getData(ni,nj,o);</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="comment">// no updates if an order 0 cell points at this cell</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="comment">// if(o&lt;=0)return;  //DGT should never happen</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="comment">// if the order increases here, there is an end to the stream segment</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keywordflow">if</span>(o&lt;oOut){</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        <span class="comment">//  This is the terminus of a stream so accumulate drops</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        drop = elevOut-&gt;getData(ni,nj,e)-elevData-&gt;getData(i,j,e);</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        <span class="comment">// the update for the order1 segments is handled differently...</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="keywordflow">if</span>(o==1){</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;            s1= s1+drop;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            s1sq= s1sq+drop*drop;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            n1= n1+1;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;            <span class="comment">//printf(&quot;Junction: %d %d %d %d\n&quot;,i,j,ni,nj);</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            <span class="comment">//fflush(stdout);</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="comment">// ... from the rest of the segments</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;            s2= s2+drop;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            s2sq= s2sq+drop*drop;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            n2= n2+1;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        }</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        <span class="comment">//  This is the continuation of a main stream to pass elevOut on down</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        elevOut-&gt;setData(i,j,elevOut-&gt;getData(ni,nj,e));</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        newstream=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    }</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;}</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">//find the orderOut of a cell based on all the incoming orders</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="keywordtype">short</span> newOrder(<span class="keywordtype">short</span> nOrder[8], <span class="keywordtype">bool</span> &amp;junction, <span class="keywordtype">bool</span> &amp;source){</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="keywordtype">short</span> i,j,temp;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <span class="keywordtype">short</span> oOut=1;  <span class="comment">//  initialize to 1</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="keywordtype">short</span> ordermax=0;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="keywordtype">short</span> count=0;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    junction=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    source=<span class="keyword">true</span>;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="comment">//  DGT revised logic to be a bit more efficient avoiding sort (and following old code)</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="keywordflow">for</span>(i=0; i&lt;8; i++)</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    {</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        <span class="keywordflow">if</span>(nOrder[i]&gt;0)  <span class="comment">// Here an inflowing stream</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        {</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;            count=count+1;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            source=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            <span class="keywordflow">if</span>(count == 1) <span class="comment">//  First inflowing stream</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            {</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                oOut=nOrder[i];</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                ordermax=nOrder[i];</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            }<span class="keywordflow">else</span>  <span class="comment">// Here count is &gt; 1</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            {</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                <span class="keywordflow">if</span>(nOrder[i]&gt; oOut)</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                {</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                    ordermax = nOrder[i];</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                    oOut=nOrder[i];</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                }</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(nOrder[i]==oOut) oOut=ordermax+1;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                <span class="comment">//  This logic to ensure that order is max of highest in or second highest in +1</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                junction=<span class="keyword">true</span>;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            }</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        }</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    }</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="comment">//sort the two largest to the bottom of the list</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <span class="comment">/*  Dan&#39;s logic DGT skipped - the sort is not necessary </span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">    for(i=0;i&lt;2;++i){</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">        for(j=0;j&lt;7;++j){</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">            if(nOrder[j]&gt;nOrder[j+1]){</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">                temp=nOrder[j];</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">                nOrder[j]=nOrder[j+1];</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">                nOrder[j+1]=temp;</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">            }</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">        }</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">    junction = false;</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">    if(nOrder[6]&gt;0)  // if 2 or more paths merge then the order of the 6th entry will be 1 or higher so flag as a junction</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">        junction=true;</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">    //if the last two have the same order, there is a junction, so bump the order</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">    if(nOrder[6]==nOrder[7]){</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">        //junction=true;</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">        oOut=nOrder[7]+1;</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">    }else{</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">        oOut=nOrder[7];</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">    }  */</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordflow">return</span> oOut;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;}</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="keywordtype">int</span> dropan(<span class="keywordtype">char</span> *areafile, <span class="keywordtype">char</span> *dirfile, <span class="keywordtype">char</span> *elevfile, <span class="keywordtype">char</span> *ssafile, <span class="keywordtype">char</span> *dropfile,</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                           <span class="keywordtype">char</span> *outletfile, <span class="keywordtype">float</span> threshmin, <span class="keywordtype">float</span> threshmax, <span class="keywordtype">int</span> nthresh, <span class="keywordtype">int</span> steptype,</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                           <span class="keywordtype">float</span> *threshopt)</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;{</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="comment">// MPI Init section</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    MPI_Init(NULL,NULL);{</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="keywordtype">int</span> rank,size;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    MPI_Comm_rank(MCW,&amp;rank);</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    MPI_Comm_size(MCW,&amp;size);</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordflow">if</span>(rank==0)</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    {</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        printf(<span class="stringliteral">&quot;DropAnalysis version %s\n&quot;</span>,TDVERSION);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        fflush(stdout);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    }</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="comment">// *** initialize thresholds array and directions table</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordtype">float</span> s1,s2,s1sq,s2sq;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="keywordtype">float</span> tempFloat;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordtype">short</span> tempShort;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <span class="keywordtype">bool</span> finished;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keywordtype">long</span> n1,n2;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordtype">bool</span> optnotset=<span class="keyword">true</span>;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="keywordtype">double</span> begint = MPI_Wtime();</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="comment">//  *** initiate fssada grid partition from ssafile</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    tiffIO ssa(ssafile, FLOAT_TYPE);  <span class="comment">// DGT changed from short type</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keywordtype">long</span> ssaTotalX = ssa.getTotalX();</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keywordtype">long</span> ssaTotalY = ssa.getTotalY();</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="keywordtype">double</span> ssadx = ssa.getdx();</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keywordtype">double</span> ssady = ssa.getdy();</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="comment">//if(rank==0)</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="comment">//  {</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="comment">//      float timeestimate=(2e-7*ssaTotalX*ssaTotalY*nthresh/pow((double) size,0.65))/60+1;  // Time estimate in minutes</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="comment">//      fprintf(stderr,&quot;This run may take on the order of %.0f minutes to complete.\n&quot;,timeestimate);</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="comment">//      fprintf(stderr,&quot;This estimate is very approximate. \nRun time is highly uncertain as it depends on the complexity of the input data \nand speed and memory of the computer. This estimate is based on our testing on \na dual quad core Dell Xeon E5405 2.0GHz PC with 16GB RAM.\n&quot;);</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="comment">//      fflush(stderr);</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="comment">//  }</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="comment">//Create partition and read data</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    tdpartition *ssaData;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    ssaData = CreateNewPartition(ssa.getDatatype(), ssaTotalX, ssaTotalY, ssadx, ssady, ssa.getNodata());</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="keywordtype">int</span> ssanx = ssaData-&gt;getnx();</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="keywordtype">int</span> ssany = ssaData-&gt;getny();</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordtype">int</span> ssaxstart, ssaystart;  </div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    ssaData-&gt;localToGlobal(0, 0, ssaxstart, ssaystart);  </div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    ssa.read((<span class="keywordtype">long</span>)ssaxstart, (<span class="keywordtype">long</span>)ssaystart, (<span class="keywordtype">long</span>)ssany, (<span class="keywordtype">long</span>)ssanx, ssaData-&gt;getGridPointer());</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordtype">float</span> ssadiag;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    ssadiag=sqrt((ssadx*ssadx)+(ssady*ssady));</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;            </div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="comment">//  *** initiate sdir grid partition from dirfile</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="comment">//printf(&quot;file %s\n&quot;,dirfile);</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    tiffIO dir(dirfile, SHORT_TYPE);</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="keywordtype">long</span> dirTotalX = dir.getTotalX();</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordtype">long</span> dirTotalY = dir.getTotalY();</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keywordtype">double</span> dirdx = dir.getdx();</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keywordtype">double</span> dirdy = dir.getdy();</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="comment">//printf(&quot;header read\n&quot;);</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="comment">//short ndv=*(short*) dir.getNodata();</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="comment">//printf(&quot;No data value %d&quot;,ndv);</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="comment">//Create partition and read data</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    tdpartition *dirData;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    dirData = CreateNewPartition(dir.getDatatype(), dirTotalX, dirTotalY, dirdx, dirdy, dir.getNodata());</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordtype">int</span> dirnx = dirData-&gt;getnx();</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="keywordtype">int</span> dirny = dirData-&gt;getny();</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordtype">int</span> dirxstart, dirystart; </div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    dirData-&gt;localToGlobal(0, 0, dirxstart, dirystart);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    dir.read((<span class="keywordtype">long</span>)dirxstart, (<span class="keywordtype">long</span>)dirystart, (<span class="keywordtype">long</span>)dirny, (<span class="keywordtype">long</span>)dirnx, dirData-&gt;getGridPointer());</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="comment">//  *** initiate Aread8 grid partition from areafile //DGT changed to float to be flexible for large areas and also to include cell size (at cost of some imprecision)</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    tiffIO area(areafile, FLOAT_TYPE);</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordtype">long</span> areaTotalX = area.getTotalX();</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordtype">long</span> areaTotalY = area.getTotalY();</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordtype">double</span> areadx = area.getdx();</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordtype">double</span> aready = area.getdy();</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="comment">//Create partition and read data</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    tdpartition *areaData;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    areaData = CreateNewPartition(area.getDatatype(), areaTotalX, areaTotalY, areadx, aready, area.getNodata());</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="keywordtype">int</span> areanx = areaData-&gt;getnx();</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <span class="keywordtype">int</span> areany = areaData-&gt;getny();</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="keywordtype">int</span> areaxstart, areaystart;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    areaData-&gt;localToGlobal(0, 0, areaxstart, areaystart);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    area.read(areaxstart, areaystart, areany, areanx, areaData-&gt;getGridPointer());</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">if</span>(!dir.compareTiff(ssa)){</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        printf(<span class="stringliteral">&quot;dir and ssa files not the same size. Exiting \n&quot;</span>);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        MPI_Abort(MCW,4);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    }</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="keywordflow">if</span>(!ssa.compareTiff(area)){</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        printf(<span class="stringliteral">&quot;ssa and area files not the same size. Exiting \n&quot;</span>);</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        MPI_Abort(MCW,4);</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    }</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">//  Read outlets</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="keywordtype">int</span> nxy;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    <span class="keywordtype">double</span> *xnode, *ynode;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordtype">int</span> i,j;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">if</span>(rank==0){</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        <span class="keywordflow">if</span>(readoutlets(outletfile, &amp;nxy, xnode, ynode)==0){</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;            MPI_Bcast(&amp;nxy, 1, MPI_INT, 0, MCW);</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;            MPI_Bcast(xnode, nxy, MPI_DOUBLE, 0, MCW);</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;            MPI_Bcast(ynode, nxy, MPI_DOUBLE, 0, MCW);</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        }</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            printf(<span class="stringliteral">&quot;Error opening shapefile. Exiting \n&quot;</span>);</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;            MPI_Abort(MCW,5);</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        }</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    }</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        MPI_Bcast(&amp;nxy, 1, MPI_INT, 0, MCW);</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        xnode = <span class="keyword">new</span> <span class="keywordtype">double</span>[nxy];</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        ynode = <span class="keyword">new</span> <span class="keywordtype">double</span>[nxy];</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        MPI_Bcast(xnode, nxy, MPI_DOUBLE, 0, MCW);</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        MPI_Bcast(ynode, nxy, MPI_DOUBLE, 0, MCW);</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    }</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="comment">// ***  sum AreaD8 at each terminal outlet this gives total area of </span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="comment">// ***  the domain being processed</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="keywordtype">float</span> totalAreaProcessed; <span class="comment">//total area of the domain being processed</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keywordtype">float</span> ta;  <span class="comment">//  DGT changed from long to float for consistency with total area processed</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordtype">int</span> tx,ty;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <span class="keywordtype">long</span> nx,ny;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="keywordtype">short</span> nd;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <span class="keywordtype">float</span> na;  <span class="comment">//DGT changed from long to float because this has to operate on SSA</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="keywordtype">int</span> *outletsX, *outletsY;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    outletsX = <span class="keyword">new</span> <span class="keywordtype">int</span>[nxy];</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    outletsY = <span class="keyword">new</span> <span class="keywordtype">int</span>[nxy];</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    totalAreaProcessed=0;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="keywordflow">for</span>( i=0; i&lt;nxy; i++){</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        area.geoToGlobalXY(xnode[i], ynode[i], outletsX[i], outletsY[i]);</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        areaData-&gt;globalToLocal(outletsX[i], outletsY[i], tx, ty);</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="keywordflow">if</span>(areaData-&gt;isInPartition(tx,ty)){</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;            ta=areaData-&gt;getData((<span class="keywordtype">long</span>) tx,(<span class="keywordtype">long</span>) ty,ta);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        <span class="comment">//only add terminal outlet areas</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        <span class="comment">// check: is terminal outlet iff downstream neighbor has area&lt;=0</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;            nd = dirData-&gt;getData((<span class="keywordtype">long</span>) tx,(<span class="keywordtype">long</span>) ty,nd);</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;            <span class="comment">//printf(&quot;Outlet direction: %d\n&quot;,nd);  //  DGT Concern that this may be no data</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;            nx = tx+d1[nd];</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            ny = ty+d2[nd];</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;            <span class="keywordflow">if</span>(ssaData-&gt;isNodata(nx,ny)  || (ssaData-&gt;getData(nx,ny,na)&lt;=0))</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            <span class="comment">//na=ssaData-&gt;getData((long)nx,(long) ny,na);   //DGT changed to ssaData from areaData - end of stream determined from ssa</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                totalAreaProcessed+=ta;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        }</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    }</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    MPI_Allreduce(&amp;totalAreaProcessed,&amp;ta,1,MPI_FLOAT,MPI_SUM,MCW);</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    totalAreaProcessed = ta*areadx*aready;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="comment">// if(!rank)cout &lt;&lt; &quot;totalAreaProcessed = &quot; &lt;&lt; totalAreaProcessed &lt;&lt; endl;</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="comment">// *** fareada no longer needed, so it&#39;s memory can be free&#39;d up</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keyword">delete</span> areaData;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="comment">// *** instantiate felevg grid partition from elevfile</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    tiffIO elev(elevfile, FLOAT_TYPE);</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="keywordtype">long</span> elevTotalX = elev.getTotalX();</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keywordtype">long</span> elevTotalY = elev.getTotalY();</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="keywordtype">double</span> elevdx = elev.getdx();</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordtype">double</span> elevdy = elev.getdy();</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="comment">//Create partition and read data</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    tdpartition *elevData;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    elevData = CreateNewPartition(elev.getDatatype(), elevTotalX, elevTotalY, elevdx, elevdy, elev.getNodata());</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keywordtype">int</span> elevnx = elevData-&gt;getnx();</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="keywordtype">int</span> elevny = elevData-&gt;getny();</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="keywordtype">int</span> elevxstart, elevystart;  </div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    elevData-&gt;localToGlobal(0, 0, elevxstart, elevystart);  </div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    elev.read((<span class="keywordtype">long</span>)elevxstart, (<span class="keywordtype">long</span>)elevystart, (<span class="keywordtype">long</span>)elevny, (<span class="keywordtype">long</span>)elevnx, elevData-&gt;getGridPointer());</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="comment">// compare to ssa size</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordflow">if</span>(!elev.compareTiff(ssa)){</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        printf(<span class="stringliteral">&quot;elev and ssa files not the same size. Exiting \n&quot;</span>);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        MPI_Abort(MCW,5);</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    }</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="comment">//  Make ssaData, dirData and elevData available to neighboring partitions once here at beginning as these are not changes</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    ssaData-&gt;share();</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    dirData-&gt;share();</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    elevData-&gt;share();</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="keywordtype">double</span> readt = MPI_Wtime();</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="comment">// num thresholds must be greater than 1</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keywordtype">float</span> thresh;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keywordflow">if</span>(nthresh&lt;2){</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        printf(<span class="stringliteral">&quot;Number of thresholds must be greater than 1. \n&quot;</span>);</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;        MPI_Abort(MCW,7);</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    }</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="comment">// *** loop over all thresholds</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordtype">int</span> th;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    FILE *fp;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="comment">//for(thresh=threshmin;thresh&lt;=threshmax;thresh+=((threshmax-threshmin)/(float) (nthresh-1))){</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="keywordflow">for</span>(th=0;th&lt;nthresh;++th){</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <span class="keywordflow">if</span>(steptype==0){</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;            <span class="keywordtype">float</span> r = exp((log(threshmax) - log(threshmin)) / (nthresh - 1));</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;            thresh = threshmin*pow(r,th);</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                    <span class="keywordtype">float</span> delta = (threshmax - threshmin) / (nthresh - 1);</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            thresh = threshmin + th * delta;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        }</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        <span class="comment">// *** instantiate arrays to hold results</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        queue &lt;node&gt; que;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        node t;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="comment">//Create partition for numcontributers</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        tdpartition *contribs;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        tdpartition *orderOut;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="comment">//tdpartition *length;</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        tdpartition *elevOut;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        contribs = CreateNewPartition(SHORT_TYPE, ssaTotalX, ssaTotalY, ssadx, ssady, MISSINGSHORT);</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        <span class="comment">//Create partitions for orderOut,length,elevOut</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        orderOut = CreateNewPartition(SHORT_TYPE, ssaTotalX, ssaTotalY, ssadx, ssady, MISSINGSHORT);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="comment">//length = CreateNewPartition(FLOAT_TYPE, ssaTotalX, ssaTotalY, ssadx, ssady, MISSINGFLOAT);</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        <span class="comment">//  Dont need length partition - just accumulate in each partition</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        <span class="keywordtype">double</span> length=0.0;  <span class="comment">// Double so as not to lose little bits when the number is big due to rounding</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        elevOut = CreateNewPartition(FLOAT_TYPE, ssaTotalX, ssaTotalY, ssadx, ssady, MISSINGFLOAT);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        s1=0.0;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        s2=0.0;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        s1sq=0.0;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        s2sq=0.0;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        n1=0;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        n2=0;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        <span class="comment">// find the number of equal/above-threshold contributers for each cell</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        <span class="keywordtype">long</span> i,j,m;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        <span class="keywordtype">short</span> d;    </div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        <span class="keywordtype">float</span> s;    <span class="comment">//DGT changed from short to float.  ssa is float</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        <span class="keywordtype">long</span> nx = ssanx;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="keywordtype">long</span> ny = ssany;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        <span class="keywordtype">short</span> k=0;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        <span class="keywordtype">long</span> nexti,nextj;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        <span class="keywordtype">float</span> e;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <span class="comment">// share borders</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        contribs-&gt;clearBorders();   <span class="comment">//  DGT changed from share</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        <span class="keywordflow">for</span>(j=0;j&lt;=ny-1;++j){</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;            <span class="keywordflow">for</span>(i=0;i&lt;nx;++i){</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                <span class="comment">// each cells looks all around and counts the arrows pointing to it</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                k=0;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                <span class="keywordflow">for</span>(m=1;m&lt;=8;++m){</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                    nexti=i+d1[m];</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                    nextj=j+d2[m];</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                    <span class="keywordflow">if</span>(pointsToMe(i,j,nexti,nextj,dirData) &amp;&amp; ssaData-&gt;getData(nexti,nextj,s)&gt;=thresh)k++;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                }</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                <span class="comment">//  Only work with cells on current stream mask</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                <span class="keywordflow">if</span>(!ssaData-&gt;isNodata(i,j) &amp;&amp; ssaData-&gt;getData(i,j,tempFloat)&gt;=thresh)</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;                    contribs-&gt;setData(i,j,k);</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                <span class="comment">// while we are at it, init data for each cell</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                <span class="comment">// init streamOrder for each cell to -1</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                <span class="comment">// DGT does not like this initialization here - they are initialized to no data upon creation</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                <span class="comment">//  and should be assigned values when they are processed</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                <span class="comment">//orderOut-&gt;setData(i,j,(short)-1);</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                <span class="comment">//length-&gt;setData(i,j,(float)0.0);</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                <span class="comment">//elevOut-&gt;setData(i,j,(float)0.0);</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            }</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        }</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <span class="comment">// put the ones with no contributers onto the que for processing.</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        <span class="keywordflow">for</span>(j=0;j&lt;ny;++j){</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;            <span class="keywordflow">for</span>(i=0;i&lt;nx;++i){</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                <span class="keywordflow">if</span>(!contribs-&gt;getData(i,j,k) &amp;&amp; ssaData-&gt;getData(i,j,s)&gt;=thresh){</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                    t.x=i;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                    t.y=j;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                    que.push(t);</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                }</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                <span class="comment">// each initial cell gets streamOrder=1</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                <span class="comment">//  DGT commented out below - will be handled during processing</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                <span class="comment">//orderOut-&gt;setData(i,j,(short)1) ;</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                <span class="comment">//elevOut-&gt;setData(i,j,elevData-&gt;getData(i,j,e)) ;</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;            }</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        }</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="comment">// each process empties its que, then shares border info, and repeats till everyone is done</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="comment">//  int globalwork=1; //int not bool for MPI_reduce</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <span class="comment">//  int localwork=1; //int not bool for MPI_reduce</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <span class="comment">//  DGT replaced with finished logic from other functions</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        finished=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="keywordflow">while</span>(!finished){</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;            <span class="comment">//globalwork=0;</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;            <span class="comment">//contribs-&gt;clearBorders();</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            <span class="keywordflow">while</span>(!que.empty()){</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                t=que.front();</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                que.pop();</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                d=dirData-&gt;getData((<span class="keywordtype">long</span>)t.x,(<span class="keywordtype">long</span>)t.y,d);</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                <span class="comment">// begin cell processing</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                <span class="keywordtype">long</span> i,j,pi,pj,pd,k;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                <span class="keywordtype">short</span> o;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                <span class="keywordtype">float</span> e;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                i=t.x;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                j=t.y;</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="comment">//              if(i==228 &amp;&amp; j==0 &amp;&amp; rank==1)</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="comment">//                  i=i;</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                <span class="keywordtype">short</span> nOrder[8];  <span class="comment">// neighborOrders</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                <span class="keywordtype">bool</span> junction; <span class="comment">// junction set to true/false in newOrder</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                <span class="comment">//put the order of all the neighboring cells into an array, and save the i,j, and elev from contributor.</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                <span class="comment">//pi,pj, and pd are useful only if there is no junction, where there is necessarily one and only</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                                <span class="comment">//one contributor.</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                <span class="comment">// TODO:  check against dropanrecursive function</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                <span class="keywordflow">for</span>(k=0;k&lt;8;++k)nOrder[k]=0;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                <span class="comment">//float l=0.0;</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                <span class="comment">//length-&gt;setData(i,j,l);  // Initialize length to 0</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                <span class="keywordflow">for</span>(m=1;m&lt;=8;++m){</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                    nexti=i+d1[m];</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                    nextj=j+d2[m];</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                    <span class="keywordflow">if</span>(pointsToMe(i,j,nexti,nextj,dirData) &amp;&amp; !orderOut-&gt;isNodata(nexti,nextj)){</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                        nOrder[m-1]=orderOut-&gt;getData(nexti,nextj,o);</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                        <span class="comment">//  Accumulate length</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                        pd=m;  <span class="comment">//DGT changed from d to m to record direction of neighbor</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                        pi=nexti;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                        pj=nextj;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                        <span class="keywordflow">if</span>(pd==1||pd==5)length=length+ssadx;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                        <span class="keywordflow">if</span>(pd==3||pd==7)length=length+ssady;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                        <span class="keywordflow">if</span>(pd%2==0)length=length+ssadiag;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                    }</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                }</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                <span class="comment">// Determine the order of this cell</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                <span class="keywordtype">short</span> oOut;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                <span class="keywordtype">bool</span> source;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                oOut = newOrder(nOrder,junction,source);</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                orderOut-&gt;setData(i,j,oOut);</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                <span class="keywordflow">if</span>(source){</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                    elevOut-&gt;setData(i,j,elevData-&gt;getData(i,j,e));</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                    <span class="comment">//printf(&quot;Source(rank:th:i:j), %d, %d, %d, %d\n&quot;,rank,th,i,j);</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                    <span class="comment">//fflush(stdout);</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(!junction){</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                    <span class="comment">// if not a junction, transfer elevOut</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                    elevOut-&gt;setData(i,j,elevOut-&gt;getData(pi,pj,e));</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                    <span class="comment">// if it is a junction, update global values</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                    <span class="comment">//  oOut = orderOut-&gt;getData(i,j,oOut);  // DGT redundant - was just set above</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                    <span class="keywordtype">bool</span> newstream=<span class="keyword">true</span>;  <span class="comment">// Flag to indicate whether the junction results in a new Strahler stream</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                    <span class="keywordflow">for</span>(k=1;k&lt;=8;++k){</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                        <span class="comment">//  d=dirData-&gt;getData(i+d1[k],j+d2[k],d);  //DGT redundant and overwrites value of d that needed to be saved for below</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                        updateAtJunction(oOut,i,i+d1[k],j,j+d2[k],nx,ny,dirData,</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                                         orderOut,elevOut,elevData,newstream,s1,s1sq,s2,s2sq,n1,n2);</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                    }</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                    <span class="keywordflow">if</span>(newstream)  <span class="comment">// Here all paths terminated at the junction so this is a new stream</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                    {</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                        elevOut-&gt;setData(i,j,elevData-&gt;getData(i,j,e));</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                    }</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                }</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                <span class="comment">// end cell processing</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment">//              if((i==227 &amp;&amp; j==127) || (i==228 &amp;&amp; j==127))</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">//                  i=i;</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                <span class="keywordtype">short</span> c;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                <span class="keywordtype">long</span> nextx,nexty;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                nextx=t.x+d1[d];</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                nexty=t.y+d2[d];</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                contribs-&gt;addToData(nextx,nexty,(<span class="keywordtype">short</span>)-1);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                <span class="comment">//Check if neighbor needs to be added to que</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                <span class="keywordflow">if</span>(elevOut-&gt;isInPartition(nextx,nexty) &amp;&amp; contribs-&gt;getData(nextx, nexty, tempShort) == 0 ){</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                    t.x=nextx;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                    t.y=nexty;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                    que.push(t);</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                }</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;            }</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;            <span class="comment">//Pass information</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;            <span class="comment">//any touched border cells have negative numbers in them.</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;            <span class="comment">//push them back to their owners, add the negatives to local</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;            <span class="comment">//cells, and put the zero cells on the local que.</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;            contribs-&gt;addBorders();</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            </div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;            <span class="comment">//also push back the data for each border cell</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;            <span class="comment">//length-&gt;share();</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;            elevOut-&gt;share();</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;            orderOut-&gt;share();</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;            <span class="comment">//If this created a cell with no contributing neighbors, put it on the queue</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;            <span class="keywordflow">for</span>(i=0; i&lt;nx; i++){</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="comment">//              if(i == 228)</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="comment">//                  i=i;</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                <span class="keywordflow">if</span>(contribs-&gt;getData(i, -1, tempShort)!=0 &amp;&amp; contribs-&gt;getData(i, 0, tempShort)==0)</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                {</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                    t.x = i;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                    t.y = 0;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                    que.push(t);</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                }</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                <span class="keywordflow">if</span>(contribs-&gt;getData(i, ny, tempShort)!=0 &amp;&amp; contribs-&gt;getData(i, ny-1, tempShort)==0)</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                {</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                    t.x = i;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                    t.y = ny-1;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                    que.push(t); </div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                }</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            }</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;            contribs-&gt;clearBorders();</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        </div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            <span class="comment">//Check if done</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            finished = que.empty();</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;            finished = orderOut-&gt;ringTerm(finished);</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        }</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    </div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        <span class="comment">// *** calculate and write results</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        MPI_Barrier(MCW);</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        <span class="keywordtype">float</span> gs1,gs2,gs1sq,gs2sq;</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        <span class="keywordtype">double</span> glen;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <span class="keywordtype">int</span> gn1,gn2;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        </div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        MPI_Reduce(&amp;s1,&amp;gs1,1,MPI_FLOAT,MPI_SUM,0,MCW);</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        MPI_Reduce(&amp;s2,&amp;gs2,1,MPI_FLOAT,MPI_SUM,0,MCW);</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        MPI_Reduce(&amp;s1sq,&amp;gs1sq,1,MPI_FLOAT,MPI_SUM,0,MCW);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        MPI_Reduce(&amp;s2sq,&amp;gs2sq,1,MPI_FLOAT,MPI_SUM,0,MCW);</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        MPI_Reduce(&amp;n1,&amp;gn1,1,MPI_INT,MPI_SUM,0,MCW);</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        MPI_Reduce(&amp;n2,&amp;gn2,1,MPI_INT,MPI_SUM,0,MCW);</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        MPI_Reduce(&amp;length,&amp;glen,1,MPI_DOUBLE,MPI_SUM,0,MCW);</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        <span class="keywordtype">float</span> drainden=glen/totalAreaProcessed;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="keywordflow">if</span>(!rank &amp;&amp; th==0){</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot;Threshold&quot;</span>;</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; DrainDen&quot;</span>;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; NoFirstOrd&quot;</span>;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; NoHighOrd&quot;</span>;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; MeanDFirstOrd&quot;</span>;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; MeanDHighOrd&quot;</span>;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; StdDevFirstOrd&quot;</span>;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; StdDevHighOrd&quot;</span>;</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; Tval&quot;</span>;</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;            cout &lt;&lt; endl;</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    </div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;            fp = fopen(dropfile,<span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;            fprintf(fp,<span class="stringliteral">&quot;Threshold, DrainDen, NoFirstOrd,NoHighOrd, MeanDFirstOrd, MeanDHighOrd, StdDevFirstOrd, StdDevHighOrd, T\n&quot;</span>);</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        }</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        <span class="keywordflow">if</span>(!rank){</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;            cout &lt;&lt; setiosflags(ios::fixed) &lt;&lt; setprecision(6) &lt;&lt; thresh;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;            cout &lt;&lt; drainden;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;            cout &lt;&lt; gn1;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;            cout &lt;&lt; gn2;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;            <span class="keywordtype">float</span> md1 = gs1/gn1; </div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            <span class="keywordflow">if</span>(gn1&gt;0)cout &lt;&lt; md1; <span class="keywordflow">else</span> cout &lt;&lt; <span class="stringliteral">&quot; - &quot;</span>;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            <span class="keywordtype">float</span> mdh = gs2/gn2; </div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;            <span class="keywordflow">if</span>(gn2&gt;0)cout &lt;&lt; mdh; <span class="keywordflow">else</span> cout &lt;&lt; <span class="stringliteral">&quot; - &quot;</span>;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            <span class="keywordtype">float</span> sd1 = sqrt((gs1sq-gn1*md1*md1)/(gn1-1)); </div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;            <span class="keywordflow">if</span>(gn1 &gt; 1)cout &lt;&lt; sd1;  <span class="keywordflow">else</span> cout &lt;&lt; <span class="stringliteral">&quot; - &quot;</span>;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;            <span class="keywordtype">float</span> sdh = sqrt((gs2sq-gn2*mdh*mdh)/(gn2-1)); </div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            <span class="keywordflow">if</span>(gn2 &gt; 1) cout &lt;&lt; sdh; <span class="keywordflow">else</span> cout &lt;&lt; <span class="stringliteral">&quot; - &quot;</span>;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            <span class="keywordtype">float</span> t = (md1-mdh)/(sqrt(((gn1-1)*sd1*sd1+(gn2-1)*sdh*sdh) / (gn1+gn2-2))*sqrt(1./gn1+1./gn2));</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            <span class="keywordflow">if</span>(gn2 &gt; 1) cout &lt;&lt; t; <span class="keywordflow">else</span> cout &lt;&lt; <span class="stringliteral">&quot; - &quot;</span>;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;            cout &lt;&lt; endl;</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;            </div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;            <span class="keywordflow">if</span>(fabs(t) &lt; 2. &amp;&amp; optnotset){ <span class="comment">// Find first occurrence of t value with absolute value less than 2.</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                    <span class="comment">//  This is the optimum</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                *threshopt=thresh;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                optnotset=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;            }</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                       <span class="comment">//  write results</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;            <span class="keywordflow">if</span>(gn1 &gt; 1 &amp;&amp; gn2 &gt; 1)</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            {</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                fprintf(fp,<span class="stringliteral">&quot;%f, &quot;</span>,thresh);</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                fprintf(fp,<span class="stringliteral">&quot;%e, &quot;</span>,drainden);</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                fprintf(fp,<span class="stringliteral">&quot;%d, &quot;</span>,gn1);</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                fprintf(fp,<span class="stringliteral">&quot;%d, &quot;</span>,gn2);</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                fprintf(fp,<span class="stringliteral">&quot;%f, &quot;</span>,md1);</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                fprintf(fp,<span class="stringliteral">&quot;%f, &quot;</span>,mdh);</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                fprintf(fp,<span class="stringliteral">&quot;%f, &quot;</span>,sd1);</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                fprintf(fp,<span class="stringliteral">&quot;%f, &quot;</span>,sdh);</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                fprintf(fp,<span class="stringliteral">&quot;%f\n&quot;</span>,t);</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            }</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        }</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        <span class="comment">//  dgt freeing memory</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        <span class="keyword">delete</span>  contribs;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        <span class="keyword">delete</span>  orderOut;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        <span class="keyword">delete</span>  elevOut;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    }</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    </div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="keywordtype">float</span> topt = *threshopt;</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    MPI_Bcast(&amp;topt,1,MPI_FLOAT,0,MCW);</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    *threshopt = topt;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    <span class="keywordflow">if</span>(!rank)</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    {</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        printf(<span class="stringliteral">&quot;%f  Value for optimum that drop analysis selected - see output file for details.\n&quot;</span>, *threshopt);</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        <span class="comment">//cout &lt;&lt; &quot;Optimum Threshold Value: &quot; &lt;&lt; *threshopt &lt;&lt; endl;</span></div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        fprintf(fp,<span class="stringliteral">&quot;Optimum Threshold Value: %f\n&quot;</span>,*threshopt);</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        fclose(fp);</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;    }</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    <span class="keywordtype">float</span> computeDropt = MPI_Wtime();</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    <span class="keywordtype">double</span> dataRead, compute, total,temp;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        dataRead = readt-begint;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        compute = computeDropt-readt;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        total = computeDropt - begint;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        MPI_Allreduce (&amp;dataRead, &amp;temp, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        dataRead = temp/size;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        MPI_Allreduce (&amp;compute, &amp;temp, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        compute = temp/size;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        MPI_Allreduce (&amp;total, &amp;temp, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        total = temp/size;</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        <span class="keywordflow">if</span>( rank == 0)</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                printf(<span class="stringliteral">&quot;Processes: %d\nRead time: %f\nCompute time: %f\nTotal time: %f\n&quot;</span>,</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                  size, dataRead, compute,total);</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    </div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    <span class="comment">// *** free memory and go home</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <span class="keyword">delete</span>  ssaData;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keyword">delete</span>  dirData;</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    <span class="keyword">delete</span>  xnode;</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="keyword">delete</span>  ynode;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <span class="keyword">delete</span>  elevData;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    }MPI_Finalize();</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;}</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_743149a2e5a84f022a66541396b6824d.html">preprocess</a></li><li class="navelem"><a class="el" href="../../dir_c5a603dc4ef604e616567644c9e0432f.html">cpp_src</a></li><li class="navelem"><a class="el" href="../../dir_de4c123db9a00eb1452e6ec6a9e67c00.html">TauDEM</a></li><li class="navelem"><b>DropAnalysis.cpp</b></li>
    <li class="footer">Generated on Sat May 21 2016 13:02:33 for SEIMS-2016 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
