<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>SEIMS-2016: preprocess/cpp_src/TauDEM/MoveOutletsToStrm.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">SEIMS-2016
   &#160;<span id="projectnumber">1.0-beta</span>
   </div>
   <div id="projectbrief">Spatially Explicit Integrated Modeling System</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dc/ded/a00252_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MoveOutletsToStrm.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*  MoveOutletsToStrm function to move outlets to a stream.</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">     </span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">  David Tarboton, Teklu Tesfa, Dan Watson</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">  Utah State University  </span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">  May 23, 2010 </span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">  This function moves outlet point that are off a stream raster grid down D8 flow directions </span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">  until a stream raster grid is encountered.  Input is a flow direction grid, stream raster grid </span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">  and outlets shapefile.  Output is a new outlets shapefile where each point has been moved to </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">  coincide with the stream raster grid if possible.  A field &#39;dist_moved&#39; is added to the new </span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">  outlets shapefile to indicate the changes made to each point.  Points that are already on the </span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">  stream raster (src) grid are not moved and their &#39;dist_moved&#39; field is assigned a value 0.  </span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">  Points that are initially not on the stream raster grid are moved by sliding them along D8 </span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">  flow directions until one of the following occurs:</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">  a.    A stream raster grid cell is encountered before traversing the max_dist number of grid cells.  </span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">   The point is moved and &#39;dist_moved&#39; field is assigned a value indicating how many grid cells the </span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">   point was moved.</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">  b.    More thanthe max_number of grid cells are traversed, or the traversal ends up going out of </span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">  the domain (encountering a no data D8 flow direction value).  The point is not moved and the </span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">  &#39;dist_moved&#39; field is assigned a value of -1.</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">/*  Copyright (C) 2010  David Tarboton, Utah State University</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">This program is free software; you can redistribute it and/or</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">modify it under the terms of the GNU General Public License </span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">version 2, 1991 as published by the Free Software Foundation.</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">GNU General Public License for more details.</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">A copy of the full GNU General Public License is included in file </span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">gpl.html. This is also available at:</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">http://www.gnu.org/copyleft/gpl.html</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">or from:</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">The Free Software Foundation, Inc., 59 Temple Place - Suite 330, </span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">Boston, MA  02111-1307, USA.</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">If you wish to use or incorporate this program (or parts of it) into </span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">other software that does not meet the GNU General Public License </span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">conditions contact the author to request permission.</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">David G. Tarboton  </span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">Utah State University </span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">8200 Old Main Hill </span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">Logan, UT 84322-8200 </span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment">USA </span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment">http://www.engineering.usu.edu/dtarb/ </span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">email:  dtarb@usu.edu </span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment">//  This software is distributed from http://hydrology.usu.edu/taudem/</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment">// 1/25/14.  Modified to use shapelib by Chris George</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#include &lt;mpi.h&gt;</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">#include &lt;queue&gt;</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="preprocessor">#include &quot;commonLib.h&quot;</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor">#include &quot;linearpart.h&quot;</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="preprocessor">#include &quot;createpart.h&quot;</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="preprocessor">#include &quot;tiffIO.h&quot;</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="preprocessor">#include &quot;shapelib/shapefil.h&quot;</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="preprocessor">#include &quot;MoveOutletsToStrm.h&quot;</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="keyword">using namespace </span>std;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keywordtype">int</span> outletstosrc(<span class="keywordtype">char</span> *pfile, <span class="keywordtype">char</span> *srcfile, <span class="keywordtype">char</span> *outletshapefile, <span class="keywordtype">char</span> *movedoutletshapefile, <span class="keywordtype">int</span> maxdist)</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;{</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    MPI_Init(NULL,NULL);{</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        <span class="keywordtype">int</span> rank,size;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        MPI_Comm_rank(MCW,&amp;rank);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        MPI_Comm_size(MCW,&amp;size);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        <span class="keywordflow">if</span>(rank==0)printf(<span class="stringliteral">&quot;MoveOutletsToStreams version %s\n&quot;</span>,TDVERSION);</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="keywordtype">double</span> begin,end;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        <span class="comment">//Begin timer</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        begin = MPI_Wtime();</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="keywordtype">int</span> d1[9] = {-99,0,-1,-1,-1,0,1,1,1};</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        <span class="keywordtype">int</span> d2[9] = {-99,1,1,0,-1,-1,-1,0,1};</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="comment">//load the stream raster grid into a linear partition</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        <span class="comment">//Create tiff object, read and store header info</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <span class="comment">//  MPI_Abort(MCW,5);</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        tiffIO src(srcfile, SHORT_TYPE);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        <span class="keywordtype">long</span> srcTotalX = src.getTotalX();</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        <span class="keywordtype">long</span> srcTotalY = src.getTotalY();</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        <span class="keywordtype">double</span> srcdx = src.getdx();</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        <span class="keywordtype">double</span> srcdy = src.getdy();</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="comment">//if(rank==0)</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        <span class="comment">//{</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        <span class="comment">//  float timeestimate=(2e-7*srcTotalX*srcTotalY/pow((double) size,0.65))/60+1;  // Time estimate in minutes</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        <span class="comment">//  fprintf(stderr,&quot;This run may take on the order of %.0f minutes to complete.\n&quot;,timeestimate);</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="comment">//  fprintf(stderr,&quot;This estimate is very approximate. \nRun time is highly uncertain as it depends on the complexity of the input data \nand speed and memory of the computer. This estimate is based on our testing on \na dual quad core Dell Xeon E5405 2.0GHz PC with 16GB RAM.\n&quot;);</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        <span class="comment">//  fflush(stderr);</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        <span class="comment">//}</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        <span class="comment">//Create partition and read data</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        tdpartition *srcData;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        srcData = CreateNewPartition(src.getDatatype(), srcTotalX, srcTotalY, srcdx, srcdy, src.getNodata());</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="keywordtype">int</span> srcnx = srcData-&gt;getnx();</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        <span class="keywordtype">int</span> srcny = srcData-&gt;getny();</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="keywordtype">int</span> srcxstart, srcystart;  <span class="comment">// DGT Why are these declared as int if they are to be used as long</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        srcData-&gt;localToGlobal(0, 0, srcxstart, srcystart);  <span class="comment">//  DGT here no typecast - but 2 lines down there is typecast - why</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        src.read((<span class="keywordtype">long</span>)srcxstart, (<span class="keywordtype">long</span>)srcystart, (<span class="keywordtype">long</span>)srcny, (<span class="keywordtype">long</span>)srcnx, srcData-&gt;getGridPointer());</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        <span class="comment">//load the d8 flow grid into a linear partition</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="comment">//Create tiff object, read and store header info</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        tiffIO p(pfile, SHORT_TYPE);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <span class="keywordtype">long</span> pTotalX = p.getTotalX();</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        <span class="keywordtype">long</span> pTotalY = p.getTotalY();</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <span class="keywordtype">double</span> pdx = p.getdx();</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="keywordtype">double</span> pdy = p.getdy();</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="comment">//Create partition and read data</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        tdpartition *flowData;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        flowData = CreateNewPartition(p.getDatatype(), pTotalX, pTotalY, pdx, pdy, p.getNodata());</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        <span class="keywordtype">int</span> pnx = flowData-&gt;getnx();</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="keywordtype">int</span> pny = flowData-&gt;getny();</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="keywordtype">int</span> pxstart, pystart;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        flowData-&gt;localToGlobal(0, 0, pxstart, pystart);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        p.read(pxstart, pystart, pny, pnx, flowData-&gt;getGridPointer());</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="keywordflow">if</span>(!p.compareTiff(src)){</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;            printf(<span class="stringliteral">&quot;src and p files not the same size. Exiting \n&quot;</span>);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;            MPI_Abort(MCW,4);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        }</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        <span class="comment">//load the shapefile that contains the unmoved src points</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="comment">//copy the shapefile to a new shapefile called shpmoved on p0</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <span class="comment">//  Code added to read shape file</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        SHPHandle sh, shmoved;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        DBFHandle dbf, dbfmoved;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keywordtype">double</span> *xnode, *ynode;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <span class="keywordtype">double</span> *origxnode, *origynode;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keywordtype">int</span> nxy;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="keywordtype">long</span> *dist_moved;  <span class="comment">//*ismoved,  DGT decided ismoved is not needed</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="keywordtype">int</span> *part_has;  <span class="comment">// variable to keep track of which partition has control of outlet</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="keywordtype">int</span> nfields;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="keywordtype">int</span> i,j;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        <span class="keywordtype">int</span> * indexMap;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        DBFFieldType * types;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordtype">int</span> dmIndex;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <span class="keywordflow">if</span>(rank==0){</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            sh = SHPOpen(outletshapefile, <span class="stringliteral">&quot;rb&quot;</span>);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            <span class="keywordtype">char</span> outletsdbf[MAXLN];</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            nameadd(outletsdbf, outletshapefile, <span class="stringliteral">&quot;.dbf&quot;</span>);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            dbf = DBFOpen(outletsdbf, <span class="stringliteral">&quot;rb&quot;</span>);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            <span class="keywordflow">if</span> ((sh != NULL) &amp;&amp; (dbf != NULL)) {</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                <span class="comment">// Strategy is to create a new shapefile with identical properties and fields</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                shmoved = SHPCreate(movedoutletshapefile, SHPT_POINT);</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                <span class="keywordtype">char</span> movedoutletsdbf[MAXLN];</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                nameadd(movedoutletsdbf, movedoutletshapefile, <span class="stringliteral">&quot;.dbf&quot;</span>);</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                dbfmoved = DBFCreate(movedoutletsdbf);</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                nfields=DBFGetFieldCount(dbf);</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                indexMap = <span class="keyword">new</span> <span class="keywordtype">int</span>[nfields];</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                types = <span class="keyword">new</span> DBFFieldType[nfields];</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                <span class="keywordtype">char</span> *fieldname = <span class="keyword">new</span> <span class="keywordtype">char</span>[12];</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                <span class="keywordflow">for</span>(i=0; i&lt;nfields; i++) {</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                    <span class="keywordtype">int</span> * pWidth = NULL;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                    <span class="keywordtype">int</span> width = 0;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                    <span class="keywordtype">int</span> * pPrecision = NULL;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                    <span class="keywordtype">int</span> precision = 0;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                    DBFFieldType type = DBFGetFieldInfo(dbf, i, fieldname, pWidth, pPrecision);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                    types[i] = type;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                    <span class="keywordflow">if</span> (pWidth == NULL) {</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                        <span class="keywordflow">if</span> (type == FTInteger) width = 6;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                        <span class="keywordflow">else</span> width = 12;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                        width = *pWidth;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                    }</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                    <span class="keywordflow">if</span> (pPrecision == NULL) {</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                        <span class="keywordflow">if</span> (type = FTDouble) precision = 1;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                        <span class="keywordflow">else</span> precision = 0;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                        precision = *pPrecision;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                    }</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                    <span class="keywordflow">if</span> (type != FTInvalid) {</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                        <span class="keywordtype">int</span> j = DBFAddField(dbfmoved, fieldname, type, width, precision);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                        indexMap[i] = j;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                        indexMap[i] = -1;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                    }</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                }</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                <span class="keyword">delete</span> [] fieldname;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                <span class="comment">//  Insert additional field to record distance moved</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                dmIndex = DBFAddField(dbfmoved, <span class="stringliteral">&quot;Dist_moved&quot;</span>, FTInteger, 6, 0);</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                nxy = DBFGetRecordCount(dbf);</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                <span class="comment">//int p_size;</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                <span class="comment">//  Code below commented out on assumption of one point per shape</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                <span class="comment">//int countPts = 0;</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                <span class="comment">//for( int i=0; i&lt;size; i++) {</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                <span class="comment">//  shp = sh.getShape(i);</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                <span class="comment">//  countPts += shp-&gt;size();</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                <span class="comment">//} </span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                printf(<span class="stringliteral">&quot;\nError opening shapefile.\n\n&quot;</span>);   </div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                nxy=0;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                <span class="comment">//      MPI_Abort(MCW,5);</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;            }</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        }</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        MPI_Bcast(&amp;nxy, 1, MPI_INT, 0, MCW);</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="keywordflow">if</span>(nxy==0)</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        {  <span class="comment">// Attempt to exit gracefully on all processors</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;            <span class="keywordflow">if</span>(rank==0)</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                printf(<span class="stringliteral">&quot;Unable to read any points from shapefile\n\n&quot;</span>);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            MPI_Finalize();</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        }</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        xnode = <span class="keyword">new</span> <span class="keywordtype">double</span>[nxy];</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        ynode = <span class="keyword">new</span> <span class="keywordtype">double</span>[nxy];</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        origxnode = <span class="keyword">new</span> <span class="keywordtype">double</span>[nxy];</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        origynode = <span class="keyword">new</span> <span class="keywordtype">double</span>[nxy];</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <span class="comment">//  ismoved = new long[nxy];  // DGT decided not needed </span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        dist_moved = <span class="keyword">new</span> <span class="keywordtype">long</span>[nxy];</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        part_has = <span class="keyword">new</span> <span class="keywordtype">int</span>[nxy];  <span class="comment">// Variable to keep track of which partition currently has control over this outlet</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="keywordtype">int</span> itresh=1;  <span class="comment">// Thresholding to 1 done in source</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="keywordflow">if</span>(rank==0){</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;            <span class="keywordflow">for</span>(i=0; i&lt;nxy; i++) {</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                SHPObject *shp = SHPReadObject(sh, i);</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                xnode[i] = shp-&gt;padfX[0];</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                ynode[i] = shp-&gt;padfY[0];</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                origxnode[i]=xnode[i];</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                origynode[i]=ynode[i];</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                <span class="comment">//  Initializing</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                <span class="comment">//          ismoved[i] = 0;</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                dist_moved[i] = 0;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                part_has[i]=-1;  <span class="comment">// initialize part_has to -1 for all points.  This will be set to rank later</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                SHPDestroyObject(shp);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;            }</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        }</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        MPI_Bcast(xnode, nxy, MPI_DOUBLE, 0, MCW);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        MPI_Bcast(ynode, nxy, MPI_DOUBLE, 0, MCW);</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        <span class="comment">//  MPI_Bcast(ismoved, nxy, MPI_LONG, 0, MCW);</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        MPI_Bcast(dist_moved, nxy, MPI_LONG, 0, MCW);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        MPI_Bcast(part_has, nxy, MPI_INT, 0, MCW);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <span class="comment">// oooooooooooooooooooooo  begin processing</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="keywordtype">int</span> *outletsX, *outletsY;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        <span class="keywordtype">int</span> tx,ty;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        <span class="keywordtype">short</span> td;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        outletsX = <span class="keyword">new</span> <span class="keywordtype">int</span>[nxy];</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        outletsY = <span class="keyword">new</span> <span class="keywordtype">int</span>[nxy];</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        <span class="keywordtype">int</span> done = 0;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        <span class="keywordtype">int</span> localdone = 0;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        <span class="keywordtype">int</span> localnodes;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        <span class="keywordtype">int</span> totalnodes;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        <span class="keywordtype">int</span> totaldone;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        <span class="keywordtype">short</span> dirn;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="keywordtype">int</span> nextx,nexty;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <span class="comment">//Convert geo coords to grid coords</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        <span class="keywordflow">for</span>( i=0; i&lt;nxy; i++)</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            p.geoToGlobalXY(xnode[i], ynode[i], outletsX[i], outletsY[i]);</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        <span class="keywordflow">while</span>(!done){</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;            <span class="keywordflow">for</span>( i=0; i&lt;nxy; i++){</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                flowData-&gt;globalToLocal(outletsX[i], outletsY[i], tx, ty);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                <span class="keywordflow">if</span>(flowData-&gt;isInPartition(tx,ty))part_has[i]=rank;  <span class="comment">// grab control if in partition</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                <span class="keywordflow">else</span> part_has[i]=-1;  <span class="comment">// some other partition has control</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                <span class="keywordflow">if</span>(flowData-&gt;isInPartition(tx,ty) &amp;&amp;dist_moved[i]&gt;=0){</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                    td=srcData-&gt;getData(tx,ty,td);</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                    <span class="comment">//  td = (char) td;  //DGT Why do we have to do this CHAR.  It seems like it was declared short so should all work</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                    <span class="keywordflow">if</span>(srcData-&gt;isNodata(tx,ty) || td&lt;itresh){  <span class="comment">//  If not on stream.  The rule is any value &gt;= itresh is a stream, less or no data is not stream</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                        <span class="comment">//move the outlet</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                        dirn = flowData-&gt;getData(tx,ty,dirn);</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                        <span class="comment">//dirn = (char) dirn;</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                        <span class="comment">//  DGT added dist_moved condition below which is: </span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                        <span class="comment">//  More than the max_number of grid cells are traversed, or the traversal ends up going out of the </span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                        <span class="comment">//  domain (encountering a no data D8 flow direction value).  </span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                        <span class="comment">//  The point is not moved and the &#39;dist_moved&#39; field is assigned a value of -1.</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                        <span class="keywordflow">if</span>(dirn&gt;=1 &amp;&amp; dirn&lt;=8 &amp;&amp; dist_moved[i] &lt; maxdist){</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                            nextx=outletsX[i]+d2[dirn];</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                            nexty=outletsY[i]+d1[dirn];</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                            <span class="keywordflow">if</span>(nextx&gt;=0 &amp;&amp; nexty&gt;=0 &amp;&amp; nextx&lt; pTotalX &amp;&amp; nexty&lt; pTotalY){  <span class="comment">// If is within global domain</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                                outletsX[i]=nextx;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                                outletsY[i]=nexty;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                                <span class="comment">//ismoved[i]=1;</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                                dist_moved[i]++;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                                <span class="comment">//printf(&quot;Outlet: %d, x: %d, y: %d\n&quot;,i,nextx,nexty);</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                            }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                                <span class="comment">// moved off the map</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                                dist_moved[i]=-1;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                            }</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                        }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                            <span class="comment">//flow data not a direction</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                            dist_moved[i]=-1;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                        }</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                    } </div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                    <span class="comment">//  No else needed because if on stream do nothing</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                }</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            }</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            <span class="comment">//share data with neighbors</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            <span class="comment">//this code is linear partition specific</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            <span class="keywordtype">int</span> * toutletsX = <span class="keyword">new</span> <span class="keywordtype">int</span>[nxy];</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;            <span class="keywordtype">int</span> * toutletsY = <span class="keyword">new</span> <span class="keywordtype">int</span>[nxy];</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            <span class="comment">//  long * tismoved = new long[nxy];</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;            <span class="keywordtype">long</span> * tdist_moved = <span class="keyword">new</span> <span class="keywordtype">long</span>[nxy];</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;            MPI_Status status;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;            <span class="keywordtype">int</span> *ptr;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            <span class="keywordtype">int</span> place;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;            <span class="keywordtype">int</span> *buf;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            <span class="keywordtype">long</span> *lbuf;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            <span class="keywordtype">int</span> bsize=nxy*<span class="keyword">sizeof</span>(int)+MPI_BSEND_OVERHEAD;  </div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            <span class="keywordtype">int</span> lsize=nxy*<span class="keyword">sizeof</span>(long)+MPI_BSEND_OVERHEAD;  </div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;            buf = <span class="keyword">new</span> <span class="keywordtype">int</span>[bsize];</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;            lbuf = <span class="keyword">new</span> <span class="keywordtype">long</span>[lsize];</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            <span class="keywordtype">int</span> txn, tyn;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            <span class="keywordtype">int</span> dest = rank-1;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            <span class="keywordflow">if</span> (dest&lt;0)dest+=size;  </div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            <span class="keywordflow">if</span>(size&gt;1){</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                MPI_Buffer_attach(buf,bsize);</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                MPI_Bsend(outletsX, nxy, MPI_INT, dest, 0, MCW);</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                MPI_Buffer_detach(&amp;ptr,&amp;place);</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                MPI_Buffer_attach(buf,bsize);</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                MPI_Bsend(outletsY, nxy, MPI_INT, dest, 1, MCW);</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                MPI_Buffer_detach(&amp;ptr,&amp;place);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                MPI_Buffer_attach(lbuf,lsize);</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                MPI_Bsend(dist_moved, nxy, MPI_LONG, dest, 3, MCW);</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                MPI_Buffer_detach(&amp;ptr,&amp;place);</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                MPI_Recv(toutletsX, nxy, MPI_INT, MPI_ANY_SOURCE, 0, MCW, &amp;status);</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                MPI_Recv(toutletsY, nxy, MPI_INT, MPI_ANY_SOURCE, 1, MCW, &amp;status);</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                MPI_Recv(tdist_moved, nxy, MPI_LONG, MPI_ANY_SOURCE, 3, MCW, &amp;status);</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            }</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            <span class="keywordflow">for</span>( i=0; i&lt;nxy; i++){</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                <span class="comment">//if a node in the temp arrays belongs to us, and we don&#39;t already have it, get it</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                flowData-&gt;globalToLocal(toutletsX[i], toutletsY[i], txn, tyn);  <span class="comment">//DGT with single partition this is being passed uninitialized information</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                flowData-&gt;globalToLocal(outletsX[i], outletsY[i], tx, ty);</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                <span class="keywordflow">if</span>(flowData-&gt;isInPartition(txn,tyn) &amp;&amp; !(part_has[i]==rank)){  <span class="comment">// if an outlet not in partition is now in partition - grab it</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                    outletsX[i]=toutletsX[i];</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                    outletsY[i]=toutletsY[i];</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                    part_has[i]=rank;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                    dist_moved[i]=tdist_moved[i];</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                }</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;            }</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;            dest = rank+1;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;            <span class="keywordflow">if</span> (dest&gt;=size)dest-=size;  <span class="comment">//DGT Why is this here.  </span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;            <span class="keywordflow">if</span>(size&gt;1){</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                MPI_Buffer_attach(buf,bsize);</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                MPI_Bsend(outletsX, nxy, MPI_INT, dest, 4, MCW);</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                MPI_Buffer_detach(&amp;ptr,&amp;place);</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                MPI_Buffer_attach(buf,bsize);</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                MPI_Bsend(outletsY, nxy, MPI_INT, dest, 5, MCW);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                MPI_Buffer_detach(&amp;ptr,&amp;place);</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                MPI_Buffer_attach(lbuf,lsize);</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                MPI_Bsend(dist_moved, nxy, MPI_LONG, dest, 7, MCW);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                MPI_Buffer_detach(&amp;ptr,&amp;place);</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                MPI_Recv(toutletsX, nxy, MPI_INT, MPI_ANY_SOURCE, 4, MCW, &amp;status);</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                MPI_Recv(toutletsY, nxy, MPI_INT, MPI_ANY_SOURCE, 5, MCW, &amp;status);</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                MPI_Recv(tdist_moved, nxy, MPI_LONG, MPI_ANY_SOURCE, 7, MCW, &amp;status);</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            }</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            <span class="keywordflow">for</span>( i=0; i&lt;nxy; i++){</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                <span class="comment">//if a node in the temp arrays belongs to us, and we don&#39;t already have it, get it</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                flowData-&gt;globalToLocal(toutletsX[i], toutletsY[i], txn, tyn);</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                flowData-&gt;globalToLocal(outletsX[i], outletsY[i], tx, ty);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                <span class="keywordflow">if</span>(flowData-&gt;isInPartition(txn,tyn) &amp;&amp; !(part_has[i]==rank)){</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                    outletsX[i]=toutletsX[i];</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                    outletsY[i]=toutletsY[i];</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                    dist_moved[i]=tdist_moved[i];</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                }</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            }</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            <span class="keyword">delete</span> [] toutletsX;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;            <span class="keyword">delete</span> [] toutletsY;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;            <span class="keyword">delete</span> [] tdist_moved;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;            <span class="comment">// each process figures out how many nodes it currently has and how many are done</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;            localnodes = 0;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;            localdone = 0;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            <span class="keywordflow">for</span>( i=0; i&lt;nxy; i++){</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                flowData-&gt;globalToLocal(outletsX[i], outletsY[i], tx, ty);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                <span class="keywordflow">if</span>(flowData-&gt;isInPartition(tx,ty)){</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                    localnodes++;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                    td=srcData-&gt;getData(tx,ty,td);</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                    <span class="comment">//td = (char) td; </span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                    <span class="keywordflow">if</span>(td&gt;=itresh &amp;&amp; ! srcData-&gt;isNodata(tx,ty))localdone++;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dist_moved[i]&lt;0)localdone++;  <span class="comment">// DGT added this as a termination condition</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                }</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;            }</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            <span class="comment">//total up all the nodes and all the finished nodes</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            MPI_Reduce(&amp;localnodes, &amp;totalnodes, 1, MPI_INT, MPI_SUM, 0, MCW);</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            MPI_Reduce(&amp;localdone, &amp;totaldone, 1, MPI_INT, MPI_SUM, 0, MCW);</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;            <span class="comment">//if(!rank)printf(&quot;dist = %d\tfinished %d out of %d nodes.\n&quot;,dist, totaldone,totalnodes);</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            <span class="comment">//if all the nodes are done or we&#39;ve moved them all maxdist, terminate the loop</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;            <span class="keywordflow">if</span>(rank==0){</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                <span class="keywordflow">if</span>(totaldone==totalnodes){  </div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                    done=1;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;                }</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;            }</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            MPI_Bcast(&amp;done,1,MPI_INT,0,MCW);</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        }</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="comment">// look for unresolved outlets, set dist_moved to -1</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="keywordflow">for</span>( i=0; i&lt;nxy; i++){</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            flowData-&gt;globalToLocal(outletsX[i], outletsY[i], tx, ty);</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            <span class="keywordflow">if</span>(flowData-&gt;isInPartition(tx,ty)){</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                td=srcData-&gt;getData(tx,ty,td);</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                <span class="keywordflow">if</span>(td&lt;itresh &amp;&amp; dist_moved[i]==maxdist){</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                    dist_moved[i]=-1;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                    <span class="comment">//              ismoved[i]=0;</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                }</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;            }</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        }</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        <span class="comment">// oooooooooooooooooooooo  end  processing</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        <span class="comment">// write the shapefile that contains the moved src points</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="keywordtype">double</span> *tempxnode, *tempynode;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        <span class="keywordtype">long</span>  *tempdist_moved;  <span class="comment">//  *tempismoved,</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        tempxnode = <span class="keyword">new</span> <span class="keywordtype">double</span>[nxy];</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        tempynode = <span class="keyword">new</span> <span class="keywordtype">double</span>[nxy];</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        <span class="comment">//  tempismoved = new long[nxy];</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        tempdist_moved = <span class="keyword">new</span> <span class="keywordtype">long</span>[nxy];</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        <span class="keywordflow">for</span>(i=0;i&lt;nxy;++i){</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;            tempxnode[i]=0;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;            tempynode[i]=0;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;            <span class="comment">//      tempismoved[i]=0;</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            tempdist_moved[i]=0;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        }</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="comment">//if(!rank)printf(&quot;setting up temp arrays...&quot;,dist, totaldone,totalnodes);</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        <span class="comment">// set temp arrays with local data in each process</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="comment">// each local array should have it&#39;s local data in the array at the proper place</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        <span class="comment">// zeros elsewhere</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        <span class="keywordflow">for</span>( i=0; i&lt;nxy; i++){</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            p.globalXYToGeo(outletsX[i], outletsY[i], xnode[i], ynode[i]);</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;            flowData-&gt;globalToLocal(outletsX[i], outletsY[i], tx, ty);</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;            <span class="keywordflow">if</span>(flowData-&gt;isInPartition(tx,ty)){</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                tempxnode[i]=xnode[i];</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                tempynode[i]=ynode[i];</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                <span class="comment">//          tempismoved[i]=ismoved[i];</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                tempdist_moved[i]=dist_moved[i];</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                <span class="comment">/*</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="comment">                printf(&quot;p%d:\t&quot;,rank);</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="comment">                printf(&quot;x:%d\t&quot;,outletsX[i]);</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="comment">                printf(&quot;y:%d\t&quot;,outletsY[i]);</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment">                printf(&quot;strm:%d\t&quot;,td);</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment">                printf(&quot;dir:%d\t&quot;,tf);</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="comment">                printf(&quot;distmvd:%d\t&quot;,dist_moved[i]);</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="comment">                printf(&quot;ismoved:%d\t&quot;,ismoved[i]);</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="comment">                printf(&quot;\n&quot;);</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="comment">                */</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;            }</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        }</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        <span class="keywordflow">if</span>(!rank){</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;            <span class="keywordflow">for</span>( i=0; i&lt;nxy; i++){</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                <span class="comment">// if the outlet is outside the DEM, p0 puts it back in the temp array</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                <span class="keywordflow">if</span>(outletsX[i]&lt;0||outletsX[i]&gt;=pTotalX||outletsY[i]&lt;0||outletsY[i]&gt;=pTotalY){</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                    tempxnode[i]=origxnode[i];</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                    tempynode[i]=origynode[i];</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                    <span class="comment">//          tempismoved[i]=0;</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                    tempdist_moved[i]=-1;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                } </div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                <span class="comment">// if dist_moved == 0, use original points</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;            }</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        }</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <span class="comment">//if(!rank)printf(&quot;done.\n&quot;,dist, totaldone,totalnodes);</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="comment">//if(!rank)printf(&quot;reducing data...&quot;,dist, totaldone,totalnodes);</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        MPI_Reduce(tempxnode, xnode, nxy, MPI_DOUBLE, MPI_SUM, 0, MCW);</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        MPI_Reduce(tempynode, ynode, nxy, MPI_DOUBLE, MPI_SUM, 0, MCW);</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;        <span class="comment">//  MPI_Reduce(tempismoved, ismoved, nxy, MPI_LONG, MPI_SUM, 0, MCW);</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        MPI_Reduce(tempdist_moved, dist_moved, nxy, MPI_LONG, MPI_SUM, 0, MCW);</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <span class="comment">//if(!rank)printf(&quot;done\n.&quot;,dist, totaldone,totalnodes);</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        <span class="keywordflow">if</span>(!rank){</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;            <span class="keywordflow">for</span>( i=0; i&lt;nxy; i++){</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                <span class="comment">// if the distance moved is 0, use original x y</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                <span class="keywordflow">if</span>(dist_moved[i]&lt;=0){  <span class="comment">// DGT changed condition to dist_moved &lt;=0 because original values kept whenever not moved for whatever reason</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                    xnode[i]=origxnode[i];</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                    ynode[i]=origynode[i];</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                } </div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;            }</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        }</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        <span class="keyword">delete</span> [] tempxnode;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        <span class="keyword">delete</span> [] tempynode;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="comment">//  delete [] tempismoved;</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keyword">delete</span> [] tempdist_moved;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        <span class="comment">//if(!rank)printf(&quot;inserting shapes...&quot;,dist, totaldone,totalnodes);</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="comment">//if(rank==0)printf(&quot;--\n&quot;);</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        <span class="keywordflow">if</span>(rank==0){</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;            <span class="keywordflow">for</span>(i=0;i&lt;nxy;++i){</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                <span class="keywordtype">double</span> x = xnode[i];  <span class="comment">// DGT says does not need +pdx/2.0;</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                <span class="keywordtype">double</span> y = ynode[i];  <span class="comment">// DGT +pdy/2.0;</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                SHPObject *shpmoved = SHPCreateSimpleObject(SHPT_POINT, 1, &amp;x, &amp;y, NULL);</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                <span class="comment">//if(rank==0)printf(&quot;x: %g \ty: %g\n&quot;,xnode[i],ynode[i]);</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                <span class="comment">//if(rank==0)printf(&quot;x: %g \ty: %g\tdist: %d\n&quot;,shpmoved-&gt;padfX[0],shpmoved-&gt;padfY[0],dist_moved[i]);</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                <span class="keywordtype">int</span> shapeIndx = SHPWriteObject(shmoved, -1, shpmoved);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                SHPDestroyObject(shpmoved);</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                <span class="keywordtype">int</span> res;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                <span class="keywordflow">for</span>(j=0;j&lt;nfields;++j){</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                    DBFFieldType type = types[j];</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                    <span class="keywordtype">int</span> fieldIndx = indexMap[j];</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                    <span class="keywordflow">if</span> ((type != FTInvalid) &amp;&amp; (fieldIndx &gt;= 0)) {</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                        <span class="keywordflow">if</span> (type = FTInteger) {</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                            <span class="keywordtype">int</span> val = DBFReadIntegerAttribute(dbf, i, j);</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                            res = DBFWriteIntegerAttribute(dbfmoved, shapeIndx, fieldIndx, val);</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                        } </div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == FTDouble) {</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                            <span class="keywordtype">double</span> val = DBFReadDoubleAttribute(dbf, i, j);</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                            res = DBFWriteDoubleAttribute(dbfmoved, shapeIndx, fieldIndx, val);</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                        }</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == FTString) {</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                            <span class="keyword">const</span> <span class="keywordtype">char</span> * val = DBFReadStringAttribute(dbf, i, j);</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                            res = DBFWriteStringAttribute(dbfmoved, shapeIndx, fieldIndx, val);</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                        }</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                        <span class="keywordflow">else</span> { <span class="comment">// FTLogical:</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                            <span class="keyword">const</span> <span class="keywordtype">char</span> * val = DBFReadLogicalAttribute(dbf, i, j);</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                            res = DBFWriteLogicalAttribute(dbfmoved, shapeIndx, fieldIndx, val[0]);</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                        }</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                    }</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                    <span class="comment">// CWG should check res is not zero</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                }</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                <span class="comment">//  Add distance moved value</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                res = DBFWriteIntegerAttribute(dbfmoved, i, dmIndex, (<span class="keywordtype">int</span>)dist_moved[i]);</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                <span class="comment">// CWG should check res is not zero</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;            }</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;            <span class="comment">//if(!rank)printf(&quot;closing file...&quot;,dist, totaldone,totalnodes);</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;            <span class="keyword">delete</span> [] indexMap;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;            <span class="keyword">delete</span> [] types;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;            SHPClose(sh);</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            DBFClose(dbf);</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            SHPClose(shmoved);</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;            DBFClose(dbfmoved);</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        }</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        <span class="comment">//if(!rank)printf(&quot;done\n.&quot;,dist, totaldone,totalnodes);</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;        <span class="keyword">delete</span> [] xnode;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        <span class="keyword">delete</span> [] ynode;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        <span class="comment">//  delete [] ismoved;</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        <span class="keyword">delete</span> [] dist_moved;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        <span class="keyword">delete</span> [] outletsX;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        <span class="keyword">delete</span> [] outletsY;</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        <span class="keyword">delete</span> [] part_has;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        end = MPI_Wtime();</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        <span class="keywordtype">double</span> total,temp;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        total = end-begin;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        MPI_Allreduce (&amp;total, &amp;temp, 1, MPI_DOUBLE, MPI_SUM, MCW);</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        total = temp/size;</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        <span class="keywordflow">if</span>( rank == 0) </div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;            printf(<span class="stringliteral">&quot;Total time: %f\n&quot;</span>,total);</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    }MPI_Finalize();</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;}</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_743149a2e5a84f022a66541396b6824d.html">preprocess</a></li><li class="navelem"><a class="el" href="../../dir_c5a603dc4ef604e616567644c9e0432f.html">cpp_src</a></li><li class="navelem"><a class="el" href="../../dir_de4c123db9a00eb1452e6ec6a9e67c00.html">TauDEM</a></li><li class="navelem"><b>MoveOutletsToStrm.cpp</b></li>
    <li class="footer">Generated on Mon Apr 25 2016 03:10:47 for SEIMS-2016 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
